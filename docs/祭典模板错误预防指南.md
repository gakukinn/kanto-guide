# 祭典模板错误预防指南

## 🎯 目标
确保 `MatsuriPageTemplate.tsx` 模板的稳定性和可靠性，防止语法错误、逻辑错误和数据问题。

## 🚨 已修复的关键错误

### 1. 语法错误修复
- **问题**：`useMemo` 依赖数组后多余分号导致编译失败
- **修复**：`}, [filteredEvents]);` 而非 `}, [filteredEvents]);`
- **预防**：使用 TypeScript 严格模式和 ESLint 检查

### 2. 变量重复声明修复
- **问题**：`filteredEvents` 同时作为 state 和 useMemo 变量
- **修复**：移除 state 声明，只保留 useMemo 计算属性
- **预防**：避免同名变量，使用明确的命名规范

### 3. 数据字段不匹配修复
- **问题**：API 返回 `name` 字段，模板期望 `title` 字段
- **修复**：智能字段映射 `event.title || event.name`
- **预防**：完整的数据验证和修复系统

## 🔧 核心错误预防机制

### A. 数据验证系统
```typescript
const validateAndFixEvents = (events: MatsuriEvent[]): MatsuriEvent[] => {
  // 1. 字段映射修复
  // 2. 年份自动添加
  // 3. 必填字段补全
  // 4. 数据类型转换
  // 5. 错误边界处理
}
```

### B. 类型安全保障
```typescript
interface MatsuriEvent {
  title?: string;    // 可选，兼容API差异
  name?: string;     // 可选，兼容API差异
  date?: string;     // 可选，兼容API差异
  dates?: string;    // 可选，兼容API差异
  // ... 其他字段
}
```

### C. 容错日期处理
```typescript
const formatDate = (dateString: string) => {
  if (!dateString) return '日期待定';
  // 多种格式支持
  // 自动年份补全
  // 错误边界处理
}
```

## 📋 强制检查清单

### 创建新祭典页面时必须检查：

#### 1. 语法检查
- [ ] 所有 `useMemo` 依赖数组正确闭合
- [ ] 没有重复的变量声明
- [ ] TypeScript 编译无错误
- [ ] ESLint 检查通过

#### 2. 数据验证
- [ ] API 数据字段映射正确
- [ ] 必填字段完整性检查
- [ ] 日期格式标准化
- [ ] 红心数为整数

#### 3. 功能测试
- [ ] 筛选器正常工作
- [ ] 排序功能正确
- [ ] 点赞功能正常
- [ ] 导航链接有效

#### 4. 显示验证
- [ ] 所有文本使用中文汉字
- [ ] 日期包含完整年份
- [ ] 红心数显示为整数
- [ ] 长文本正确截断

## 🛠️ 开发工具配置

### package.json 脚本
```json
{
  "scripts": {
    "validate-matsuri": "tsc --noEmit && eslint src/components/MatsuriPageTemplate.tsx",
    "test-matsuri": "npm run validate-matsuri && npm run build"
  }
}
```

### TypeScript 配置
```json
{
  "compilerOptions": {
    "strict": true,
    "noUnusedLocals": true,
    "noUnusedParameters": true,
    "exactOptionalPropertyTypes": true
  }
}
```

## 🚫 绝对禁止的操作

### 1. 语法层面
- ❌ 在 `useMemo` 依赖数组后添加分号
- ❌ 重复声明同名变量
- ❌ 忽略 TypeScript 编译错误
- ❌ 跳过 ESLint 检查

### 2. 数据层面
- ❌ 假设 API 字段名称固定
- ❌ 忽略数据验证
- ❌ 硬编码年份信息
- ❌ 允许非整数红心数

### 3. 功能层面
- ❌ 跳过功能测试
- ❌ 忽略错误边界
- ❌ 假设数据格式正确
- ❌ 省略容错处理

## 🔍 自动化验证脚本

### 语法检查脚本
```bash
#!/bin/bash
echo "🔍 检查祭典模板语法..."
npx tsc --noEmit src/components/MatsuriPageTemplate.tsx
if [ $? -eq 0 ]; then
  echo "✅ TypeScript 检查通过"
else
  echo "❌ TypeScript 检查失败"
  exit 1
fi
```

### 数据验证脚本
```javascript
// scripts/validate-matsuri-template.js
const fs = require('fs');
const path = require('path');

function validateTemplate() {
  const templatePath = 'src/components/MatsuriPageTemplate.tsx';
  const content = fs.readFileSync(templatePath, 'utf8');
  
  // 检查常见错误模式
  const errors = [];
  
  if (content.includes('}, [filteredEvents]);')) {
    errors.push('❌ useMemo 依赖数组后有多余分号');
  }
  
  if (content.match(/const filteredEvents.*useState/)) {
    errors.push('❌ filteredEvents 重复声明');
  }
  
  if (errors.length > 0) {
    console.error('🚨 发现模板错误：');
    errors.forEach(error => console.error(error));
    process.exit(1);
  }
  
  console.log('✅ 模板验证通过');
}

validateTemplate();
```

## 📊 质量保证指标

### 必须达到的标准：
- **编译成功率**：100%
- **类型安全性**：100%
- **数据验证覆盖**：100%
- **错误边界处理**：100%
- **功能测试通过率**：100%

### 性能指标：
- **首次渲染时间**：< 500ms
- **筛选响应时间**：< 100ms
- **内存使用稳定**：无内存泄漏
- **重新渲染次数**：最小化

## 🔄 持续改进流程

### 1. 错误发现
- 立即记录错误详情
- 分析根本原因
- 更新预防机制

### 2. 修复验证
- 修复后完整测试
- 更新文档说明
- 添加自动化检查

### 3. 预防强化
- 更新检查清单
- 改进验证脚本
- 培训开发规范

## 🎯 最佳实践总结

### 代码编写
1. **先写类型定义**，再写实现
2. **使用 useMemo** 避免无限循环
3. **添加错误边界**处理异常
4. **编写容错代码**处理数据问题

### 测试验证
1. **编译检查**必须通过
2. **功能测试**必须完整
3. **数据验证**必须严格
4. **性能测试**必须达标

### 文档维护
1. **及时更新**错误案例
2. **完善预防**机制说明
3. **记录最佳**实践经验
4. **分享解决**方案知识

---

**核心原则：预防胜于修复，质量重于速度，稳定性是第一要务。** 
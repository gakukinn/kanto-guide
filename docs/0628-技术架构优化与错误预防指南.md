
**版本**: v1.0  
**适用范围**: JapanGuide项目所有页面生成器

## 🎯 核心原则

### 1. 静态页面与数据库分离原则
```
✅ 静态页面：使用JSON文件存储，不依赖Prisma数据库
❌ 动态页面：可以使用数据库，但需明确区分
```

**关键记忆点**：
- 四层页面（详情页面）= 静态页面 = 只用JSON文件
- 管理后台 = 动态页面 = 可以用数据库
- 绝不在静态页面逻辑中引入数据库依赖

### 2. 统一路径命名规则
```
标准格式: /{region}/{activityType}/{detailPageFolder}
示例: /tokyo/hanabi/activity-2025-summer-festival-abc123
```

**组成部分**：
- `region`: 地区代码（tokyo, kanagawa等）
- `activityType`: 活动类型（hanabi, matsuri等）
- `detailPageFolder`: 智能生成的文件夹名（activity-年份-关键词-随机ID）

### 3. JSON文件标准结构
```
单个活动: data/activities/{id}.json
地区汇总: data/regions/{region}/{activityType}.json
```

## 🔧 技术实现标准

### A. 页面生成器API结构
```javascript
// 标准POST请求参数
{
  data: Object,           // 活动数据
  activityType: string,   // 活动类型
  region: string,         // 地区
  images: Array,          // 图片数组
  duplicateAction: string,// 重复处理动作
  overwriteTarget: string,// 覆盖目标ID
  forceOverwrite: boolean // 强制覆盖标志
}

// 标准响应格式
{
  success: boolean,
  message: string,
  pageUrl?: string,
  conflictData?: Object  // 冲突时返回
}
```

### B. 智能重复检测算法
```javascript
// 相似度判断条件
const isDuplicate = 
  nameSimilarity >= 85 ||
  (nameSimilarity >= 75 && (areDatesSimilar || areAddressesSimilar)) ||
  (nameSimilarity >= 30 && areDatesSimilar && areAddressesSimilar);

// 计算函数
function calculateSimilarity(str1, str2) {
  // 使用Levenshtein距离算法
  const distance = levenshteinDistance(str1, str2);
  const maxLength = Math.max(str1.length, str2.length);
  return ((maxLength - distance) / maxLength) * 100;
}
```

### C. 覆盖功能实现标准
```javascript
// ID管理逻辑
let staticId: string;
if (duplicateCheck.isDuplicate && forceOverwrite && overwriteTarget) {
  staticId = overwriteTarget; // 重用现有ID
} else {
  staticId = Date.now().toString(); // 生成新ID
}

// 覆盖操作顺序
1. 检测重复 → 2. 用户确认 → 3. 重用ID → 4. 覆盖文件
```

## 🚨 常见错误模式与预防

### 错误类型1：数据库依赖混淆
**错误示例**：
```javascript
// ❌ 错误：在静态页面逻辑中使用Prisma
const dbRecord = await prisma.hanabiEvent.findFirst({...});
```

**正确做法**：
```javascript
// ✅ 正确：静态页面只使用JSON文件
const jsonData = JSON.parse(await fs.readFile(`data/activities/${id}.json`, 'utf8'));
```

**预防措施**：
- 在文件头部添加注释标明页面类型
- 代码审查时重点检查数据源
- 建立明确的文件命名约定

### 错误类型2：字段映射顺序错误
**错误示例**：
```javascript
// ❌ 错误：优先级顺序不当
description: data.eventName || data.name || data.description
```

**正确做法**：
```javascript
// ✅ 正确：优先使用处理后的标准字段
description: data.description || data.parsedDescription || data.name || data.eventName || ''
```

**预防措施**：
- 建立字段优先级文档
- 使用TypeScript接口强制类型检查
- 添加数据验证函数

### 错误类型3：覆盖功能ID冲突
**错误示例**：
```javascript
// ❌ 错误：覆盖时仍生成新ID
const newId = Date.now().toString();
```

**正确做法**：
```javascript
// ✅ 正确：覆盖时重用现有ID
const staticId = (isOverwrite && targetId) ? targetId : Date.now().toString();
```

**预防措施**：
- 明确区分新建和覆盖模式
- 添加ID重用逻辑验证
- 记录详细的操作日志

### 错误类型4：TypeScript作用域问题
**错误示例**：
```javascript
// ❌ 错误：const变量重新赋值
const overwriteTarget = providedTarget;
if (condition) {
  overwriteTarget = newTarget; // TypeError
}
```

**正确做法**：
```javascript
// ✅ 正确：合理的变量声明
let overwriteTarget = providedTarget;
if (condition) {
  overwriteTarget = newTarget; // OK
}
```

**预防措施**：
- 明确变量的可变性需求
- 使用let/const的最佳实践
- 设计合理的变量作用域

## 📋 开发检查清单

### 页面生成器开发清单
- [ ] 确认页面类型（静态/动态）
- [ ] 检查数据源类型（JSON/数据库）
- [ ] 验证路径命名规则
- [ ] 实现智能重复检测
- [ ] 添加覆盖功能支持
- [ ] 配置图片搜索功能
- [ ] 测试所有错误场景
- [ ] 添加详细日志记录

### 模板组件开发清单
- [ ] 添加"use client"指令（如需要）
- [ ] 定义清晰的TypeScript接口
- [ ] 实现响应式布局
- [ ] 保持样式一致性
- [ ] 支持必要的字段类型
- [ ] 添加错误边界处理
- [ ] 测试各种数据格式

### 数据处理开发清单
- [ ] 验证输入数据格式
- [ ] 实现字段映射逻辑
- [ ] 添加数据清洗功能
- [ ] 支持多语言内容
- [ ] 处理缺失字段情况
- [ ] 记录数据转换日志

## 🔄 持续改进机制

### 1. 错误监控体系
```javascript
// 错误捕获和记录
try {
  // 业务逻辑
} catch (error) {
  console.error(`🚨 ${functionName} 错误:`, error);
  // 记录到错误日志
  await logError(error, context);
  throw error;
}
```

### 2. 性能监控指标
- 页面生成时间：< 500ms
- 图片搜索响应：< 1000ms
- 重复检测时间：< 100ms
- JSON文件写入：< 50ms

### 3. 代码质量保证
```json
// package.json scripts
{
  "lint": "eslint . --ext .ts,.tsx",
  "type-check": "tsc --noEmit",
  "test": "jest",
  "validate-all": "npm run lint && npm run type-check && npm run test"
}
```

### 4. 文档维护标准
- 每次重大修改后更新技术文档
- 记录所有错误模式和解决方案
- 维护API接口变更日志
- 更新开发者指南和最佳实践

## 📊 技术债务管理

### 已知技术债务
1. **图片搜索缓存**: 当前每次都重新搜索，可以添加缓存机制
2. **错误处理**: 部分API缺少详细的错误分类和用户友好提示
3. **测试覆盖**: 缺少自动化测试，特别是覆盖功能的测试
4. **性能优化**: 大量JSON文件读写可以考虑批量处理

### 优先级排序
1. **高优先级**: 添加自动化测试，确保功能稳定性
2. **中优先级**: 实现图片搜索缓存，提升用户体验
3. **低优先级**: 优化JSON文件处理性能

## 🎓 团队知识传承

### 新AI协作者快速上手指南
1. **第一步**: 阅读本文档和项目背景
2. **第二步**: 理解静态页面与数据库分离原则
3. **第三步**: 熟悉统一的路径命名规则
4. **第四步**: 掌握智能重复检测逻辑
5. **第五步**: 了解覆盖功能实现机制

### 关键概念记忆卡片
```
卡片1: 四层页面 = 静态页面 = 只用JSON文件
卡片2: 路径格式 = /{region}/{activityType}/{detailPageFolder}
卡片3: 覆盖逻辑 = 检测→确认→重用ID→覆盖文件
卡片4: 字段优先级 = 处理后字段 > 原始字段 > 默认值
```

---

**结语**: 这份指南汇总了项目开发中的核心技术原则和错误预防措施。遵循这些标准可以避免常见错误，提高开发效率，确保项目质量。建议所有协作者在开发前仔细阅读并严格执行。 
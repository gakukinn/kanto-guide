# 🎌 祭典数据系统 AI 工作流程指南

## 📝 系统概述

本系统是为关东旅游网站创建的专业级祭典数据管理系统，基于Next.js 15 + TypeScript构建。系统采用自动化数据抓取、定时任务调度、严格数据验证的架构，确保祭典信息的准确性和时效性。

## 🏗️ 核心架构

### 技术栈
- **前端**: Next.js 15 + TypeScript + Tailwind CSS
- **数据抓取**: Crawlee + Playwright
- **数据验证**: Zod Schema
- **任务调度**: Node-cron
- **数据存储**: JSON文件 (可扩展到数据库)

### 关键文件结构
```
src/
├── types/matsuri.ts              # 数据类型定义
├── lib/
│   ├── crawler/matsuri-crawler.ts    # 数据爬虫
│   ├── services/matsuri-data-service.ts # 数据服务
│   └── scheduler/matsuri-scheduler.ts   # 定时调度
├── app/
│   ├── tokyo/matsuri/page.tsx        # 祭典展示页面
│   └── api/
│       ├── matsuri/route.ts          # 祭典API
│       └── admin/matsuri/route.ts    # 管理API
scripts/
├── matsuri-cli.js               # 命令行工具
└── matsuri-demo.js             # 系统演示
docs/
├── MATSURI_SYSTEM_GUIDE.md     # 系统文档
└── AI_MATSURI_WORKFLOW.md      # 本文件
```

## ⏰ 自动化调度策略

### 调度频率（已优化）
- **数据更新**: 每月1日凌晨2点
- **数据验证**: 每月15日凌晨3点  
- **即将活动检查**: 每周一凌晨1点

### 调度原理
祭典活动信息相对稳定，月度更新频率既保证了数据时效性，又避免了对数据源的过度请求。

## 🛠️ AI 操作工作流程

### 1. 日常维护检查

#### 步骤 1: 系统健康检查
```bash
npm run matsuri:health
```
**检查项目**:
- 数据文件完整性
- API接口响应
- 调度器状态
- 最近更新时间

#### 步骤 2: 数据验证
```bash
npm run matsuri:validate
```
**验证内容**:
- 数据格式正确性
- 必填字段完整性
- 日期格式规范
- URL有效性

#### 步骤 3: 统计报告
```bash
npm run matsuri:stats
```
**获取信息**:
- 总祭典数量
- 各地区分布
- 近期活动统计
- 数据源健康度

### 2. 数据更新流程

#### 手动更新（推荐在自动更新失败时使用）
```bash
npm run matsuri:update
```

#### 指定地区更新
```bash
node scripts/matsuri-cli.js update --prefecture tokyo
```

#### 强制重新抓取
```bash
node scripts/matsuri-cli.js update --force
```

### 3. 问题排查流程

#### 情况 1: 数据更新失败
1. 检查网络连接和数据源可用性
2. 查看错误日志: `logs/matsuri-errors.log`
3. 尝试手动更新单个地区
4. 如果持续失败，检查数据源网站是否有结构变化

#### 情况 2: 页面显示错误
1. 验证数据格式: `npm run matsuri:validate`
2. 检查API响应: 访问 `/api/matsuri`
3. 查看浏览器控制台错误
4. 重启开发服务器

#### 情况 3: 调度器未运行
1. 检查进程状态
2. 查看调度器日志
3. 重启调度器: `npm run matsuri:schedule`

### 4. 新功能开发流程

#### 添加新数据源
1. 在 `matsuri-crawler.ts` 中添加新的爬虫方法
2. 更新数据类型定义 `types/matsuri.ts`
3. 测试数据抓取功能
4. 更新验证规则

#### 修改数据结构
1. 更新 TypeScript 类型定义
2. 修改 Zod 验证模式
3. 更新前端显示组件
4. 运行完整测试流程

#### 添加新API端点
1. 在 `app/api/` 下创建新路由
2. 实现相应的服务方法
3. 添加错误处理
4. 更新API文档

## 🚨 关键注意事项

### 数据准确性原则
- **绝对禁止编造数据**: 所有信息必须来自可靠官方源
- **数据源优先级**: 官方网站 > 旅游局 > 知名旅游平台
- **验证要求**: 每次更新后必须验证数据完整性

### 性能考虑
- 避免频繁请求数据源网站
- 使用缓存机制减少重复抓取
- 监控系统资源使用情况

### 错误处理
- 所有操作都有详细的错误日志
- 网络错误时使用重试机制
- 数据验证失败时保留旧数据

## 📊 监控与维护

### 每周检查清单
- [ ] 查看系统健康状态
- [ ] 检查近期错误日志
- [ ] 验证即将到来的活动信息
- [ ] 确认页面正常显示

### 每月检查清单
- [ ] 运行完整数据验证
- [ ] 更新过期活动状态
- [ ] 检查数据源网站变化
- [ ] 备份重要数据文件
- [ ] 审查系统性能指标

### 季度检查清单
- [ ] 评估数据源质量
- [ ] 优化爬虫策略
- [ ] 更新系统依赖
- [ ] 进行安全检查

## 🔧 故障恢复

### 数据丢失恢复
1. 从 `data/backup/` 恢复备份文件
2. 重新运行数据验证
3. 手动补充缺失数据

### 系统崩溃恢复
1. 检查错误日志定位问题
2. 重启相关服务
3. 验证数据完整性
4. 恢复定时任务

## 📞 支持与联系

遇到技术问题时的处理顺序:
1. 查阅本文档和系统文档
2. 检查错误日志和控制台输出
3. 运行诊断命令
4. 查看GitHub Issues或创建新Issue

## 🎯 成功标准

系统正常运行的标志:
- 数据每月自动更新成功
- 页面正常显示祭典信息
- API接口响应正常
- 无重大错误日志
- 用户反馈良好

---

**最后更新**: 2025年1月13日
**维护者**: AI助手
**系统版本**: v1.0.0 
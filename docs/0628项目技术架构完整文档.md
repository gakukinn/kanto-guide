# JapanGuide项目技术架构完整文档

**文档版本**: v2.0  

**合并来源**: 合并了3个技术架构相关文档  
**项目状态**: 核心功能完成，生产就绪  

---

## 🏗️ 架构总览

### 设计理念
**静态页面优先架构**: 四层页面使用JSON文件存储，管理后台使用数据库，根据数据特性选择最适合的存储方式。

```
架构特点:
├── 静态优先: 四层页面最大化静态内容，减少服务器负载
├── 数据分离: JSON文件存储 + 数据库混合架构
├── 数据驱动: 基于JSON文件的页面数据管理
└── 组件化: 可复用的React组件系统
```

### 核心技术栈

#### 前端框架
```typescript
// Next.js 15 - 现代React框架
const frameworkFeatures = {
  appRouter: "App Router架构，支持嵌套布局",
  serverComponents: "React Server Components，优化性能", 
  staticGeneration: "静态站点生成，SEO友好",
  serverSideRendering: "服务端渲染，动态数据支持",
  apiRoutes: "内置API路由，后端功能集成"
};
```

#### 开发语言
```typescript
// TypeScript 5.x - 类型安全的JavaScript
interface TechStack {
  language: "TypeScript 5.x";
  benefits: [
    "编译时类型检查",
    "更好的IDE支持", 
    "代码可维护性",
    "团队协作效率"
  ];
  configuration: "严格模式，全项目覆盖";
}
```

#### 样式系统
```css
/* Tailwind CSS - 实用优先的CSS框架 */
.advantages {
  @apply 
    /* 快速开发 */ rapid-development
    /* 一致性设计 */ consistent-design  
    /* 响应式布局 */ responsive-layout
    /* 优化构建 */ optimized-build;
}
```

#### 数据存储
```prisma
// Prisma + SQLite - 现代数据库工具链（仅用于管理后台）
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = "file:./dev.db"
}

// 四层页面使用JSON文件存储
// data/activities/{id}.json - 单个活动数据
// data/regions/{region}/{activityType}.json - 地区活动汇总
```

---

## 📱 页面架构设计

### 四层页面结构
```
页面层级架构:
├── Layer 1: 首页 (/) 
│   └── 渲染方式: 静态生成 (SSG)
│   └── 数据源: 硬编码配置
│
├── Layer 2: 地区首页 (/tokyo, /saitama, ...)
│   └── 渲染方式: 静态生成 (SSG)  
│   └── 数据源: 静态配置文件
│
├── Layer 3: 活动列表页 (/tokyo/hanabi, /saitama/matsuri, ...)
│   └── 渲染方式: 服务端渲染 (SSR)
│   └── 数据源: JSON文件动态读取
│
└── Layer 4: 活动详情页 (/tokyo/hanabi/activity-xxx, ...)
    └── 渲染方式: 静态生成 (SSG)
    └── 数据源: JSON文件存储
```

### 关键架构原则

#### 1. 静态页面与数据库分离原则
```
✅ 静态页面（四层页面）：使用JSON文件存储，不依赖Prisma数据库
✅ 动态页面（管理后台）：使用数据库，支持CRUD操作
❌ 禁止：在静态页面逻辑中引入数据库依赖
```

#### 2. 数据一致性保证
```typescript
// 数据验证接口
interface DataValidation {
  jalanStandards: {
    requiredFields: ["name", "address", "datetime", "venue", "access"];
    optionalFields: ["organizer", "price", "contact", "website", "googleMap"];
  };
  chineseLocalization: {
    noJapaneseKana: true;
    chineseCharactersOnly: true;
  };
}
```

---

## 🗄️ 数据架构

### 混合存储策略

#### JSON文件存储（四层页面）
```javascript
// 单个活动数据结构
{
  "id": "1751045840586",
  "name": "2025年J-POP BEST东京竞马场花火",
  "description": "详细活动描述",
  "highlights": "活动亮点", 
  "address": "东京都府中市日吉町1-1",
  "datetime": "2025年7月10日 19:00-20:30",
  "venue": "东京竞马场",
  "access": "JR中央线东府中站步行1分钟",
  "organizer": "JRA东京竞马场",
  "price": "指定席3000日元起",
  "contact": "042-363-3141",
  "website": "https://www.jra.go.jp/facilities/race/tokyo/",
  "googleMap": "https://maps.google.com/maps?..."
}
```

#### 数据库存储（管理后台）
```prisma
// 活动实体（管理后台使用）
model Activity {
  id          String   @id @default(cuid())
  region      String   // 地区代码
  activityType String  // 活动类型
  detailLink  String?  // 详情页链接
  
  // Jalan十项标准字段
  name        String   // 1. 活动名称
  address     String   // 2. 所在地址  
  datetime    String   // 3. 开催时间
  venue       String   // 4. 开催场所
  access      String   // 5. 交通方式
  organizer   String   // 6. 主办方
  price       String   // 7. 费用信息
  contact     String   // 8. 联系方式
  website     String   // 9. 官方网站
  googleMap   String   // 10. 地图链接
  
  // 扩展字段
  description String?  // 活动描述
  highlights  String?  // 活动亮点
  status      String   @default("active")
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@index([region, activityType, status])
}
```

---

## 🔧 核心技术实现

### A. 页面生成器标准
```javascript
// 标准POST请求参数
{
  data: Object,           // 活动数据
  activityType: string,   // 活动类型（hanabi, matsuri等）
  region: string,         // 地区（tokyo, kanagawa等）
  images: Array,          // 图片数组
  duplicateAction: string,// 重复处理动作
  overwriteTarget: string,// 覆盖目标ID
  forceOverwrite: boolean // 强制覆盖标志
}

// 标准响应格式
{
  success: boolean,
  message: string,
  pageUrl?: string,
  conflictData?: Object  // 冲突时返回
}
```

### B. 智能重复检测算法
```javascript
// 相似度判断条件
const isDuplicate = 
  nameSimilarity >= 85 ||
  (nameSimilarity >= 75 && (areDatesSimilar || areAddressesSimilar)) ||
  (nameSimilarity >= 30 && areDatesSimilar && areAddressesSimilar);

// 计算函数
function calculateSimilarity(str1, str2) {
  // 使用Levenshtein距离算法
  const distance = levenshteinDistance(str1, str2);
  const maxLength = Math.max(str1.length, str2.length);
  return ((maxLength - distance) / maxLength) * 100;
}
```

### C. 路径命名规则
```
标准格式: /{region}/{activityType}/{detailPageFolder}
示例: /tokyo/hanabi/activity-2025-summer-festival-abc123

组成部分：
- region: 地区代码（tokyo, kanagawa等）
- activityType: 活动类型（hanabi, matsuri等）  
- detailPageFolder: 智能生成的文件夹名（activity-年份-关键词-随机ID）
```

---

## 🚨 错误预防体系

### 常见错误模式与预防

#### 错误类型1：数据库依赖混淆
```javascript
// ❌ 错误：在静态页面逻辑中使用Prisma
const dbRecord = await prisma.activity.findFirst({...});

// ✅ 正确：静态页面只使用JSON文件
const jsonData = JSON.parse(await fs.readFile(`data/activities/${id}.json`, 'utf8'));
```

#### 错误类型2：字段映射顺序错误
```javascript
// ❌ 错误：优先级顺序不当
description: data.eventName || data.name || data.description

// ✅ 正确：优先使用处理后的标准字段
description: data.description || data.parsedDescription || data.name || data.eventName || ''
```

#### 错误类型3：覆盖功能ID冲突
```javascript
// ❌ 错误：覆盖时仍生成新ID
const newId = Date.now().toString();

// ✅ 正确：覆盖时重用现有ID
const staticId = (isOverwrite && targetId) ? targetId : Date.now().toString();
```

### 开发检查清单

#### 页面生成器开发清单
- [ ] 确认页面类型（静态/动态）
- [ ] 检查数据源类型（JSON/数据库）
- [ ] 验证路径命名规则
- [ ] 实现智能重复检测
- [ ] 添加覆盖功能支持
- [ ] 配置图片搜索功能
- [ ] 测试所有错误场景
- [ ] 添加详细日志记录

#### 模板组件开发清单
- [ ] 添加"use client"指令（如需要）
- [ ] 定义清晰的TypeScript接口
- [ ] 实现响应式布局
- [ ] 保持样式一致性
- [ ] 支持必要的字段类型
- [ ] 添加错误边界处理
- [ ] 测试各种数据格式

---

## 🔄 持续改进机制

### 代码质量保证
```javascript
// TypeScript严格模式配置
{
  "compilerOptions": {
    "strict": true,
    "noImplicitAny": true,
    "strictNullChecks": true,
    "noUnusedLocals": true,
    "noUnusedParameters": true
  }
}
```

### 自动化测试
```javascript
// Jest + Testing Library测试配置
describe('页面生成器', () => {
  test('JSON文件存储验证', () => {
    // 测试JSON文件正确生成
  });
  
  test('重复检测算法验证', () => {
    // 测试相似度计算准确性
  });
  
  test('路径命名规则验证', () => {
    // 测试URL路径生成正确性
  });
});
```

### 性能监控
```javascript
// 页面加载性能指标
const performanceMetrics = {
  LCP: "< 2.5s",  // 最大内容绘制
  FID: "< 100ms", // 首次输入延迟
  CLS: "< 0.1",   // 累积布局偏移
  TTFB: "< 800ms" // 首字节时间
};
```

---

## 📋 部署与运维

### 部署环境
```bash
# 生产环境配置
NODE_ENV=production
NEXT_PUBLIC_SITE_URL=https://japan-guide.example.com
DATABASE_URL=file:./production.db

# 构建命令
npm run build
npm start
```

### 监控指标
- **页面加载速度**: < 2秒
- **JSON文件读取**: < 100ms
- **数据库查询**: < 200ms（管理后台）
- **静态资源缓存**: 30天

---

## 📚 参考资料

### 官方文档
- [Next.js 15 文档](https://nextjs.org/docs)
- [TypeScript 手册](https://www.typescriptlang.org/docs/)
- [Tailwind CSS 文档](https://tailwindcss.com/docs)
- [Prisma 文档](https://www.prisma.io/docs/)

### 项目特定资源
- Walker Plus官方数据源
- Jalan十项标准规范
- 中文本地化指南
- 图片资源管理规范

---

**文档维护**: 当技术架构发生重大变更时，请及时更新此文档
**版本控制**: 使用Git跟踪文档变更历史 
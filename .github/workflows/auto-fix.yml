name: Auto Fix Issues

on:
  schedule:
    # æ¯å¤©å‡Œæ™¨2ç‚¹è¿è¡Œ
    - cron: '0 2 * * *'
  workflow_dispatch: # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  auto-fix:
    name: Auto Fix Common Issues
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Auto-fix TypeScript errors
        run: |
          # åˆ›å»ºè‡ªåŠ¨ä¿®å¤è„šæœ¬
          cat > auto-fix-types.js << 'EOF'
          const fs = require('fs');
          const path = require('path');
          
          function fixHanabiMediaFields(dir) {
            const files = fs.readdirSync(dir, { withFileTypes: true });
            let fixedFiles = [];
            
            for (const file of files) {
              const fullPath = path.join(dir, file.name);
              if (file.isDirectory()) {
                fixedFiles = fixedFiles.concat(fixHanabiMediaFields(fullPath));
              } else if (file.name === 'page.tsx') {
                try {
                  let content = fs.readFileSync(fullPath, 'utf8');
                  let modified = false;
                  
                  // ä¿®å¤åª’ä½“å­—æ®µç»“æ„
                  if (content.includes('media:') && content.includes('alt:') && content.includes('caption:')) {
                    // å°† alt å’Œ caption æ›¿æ¢ä¸º title å’Œ description
                    content = content.replace(/alt:\s*['"`]([^'"`]*?)['"`]/g, 'title: "$1"');
                    content = content.replace(/caption:\s*['"`]([^'"`]*?)['"`]/g, 'description: "$1"');
                    modified = true;
                  }
                  
                  // ç¡®ä¿åª’ä½“å¯¹è±¡æœ‰å¿…éœ€çš„å­—æ®µ
                  if (content.includes('media:') && !content.includes('title:')) {
                    content = content.replace(
                      /(media:\s*\[[\s\S]*?{\s*)/g, 
                      '$1title: "èŠ±ç«å¤§ä¼šå›¾ç‰‡",\n        '
                    );
                    modified = true;
                  }
                  
                  if (content.includes('media:') && !content.includes('description:')) {
                    content = content.replace(
                      /(title:\s*['"`][^'"`]*['"`],?\s*)/g, 
                      '$1\n        description: "èŠ±ç«å¤§ä¼šç²¾å½©ç¬é—´",'
                    );
                    modified = true;
                  }
                  
                  if (modified) {
                    fs.writeFileSync(fullPath, content, 'utf8');
                    fixedFiles.push(fullPath);
                  }
                } catch (e) {
                  console.log(`Failed to process ${fullPath}: ${e.message}`);
                }
              }
            }
            return fixedFiles;
          }
          
          const fixedFiles = fixHanabiMediaFields('./src/app');
          if (fixedFiles.length > 0) {
            console.log('Fixed files:');
            fixedFiles.forEach(file => console.log(file));
          } else {
            console.log('No files needed fixing.');
          }
          EOF
          
          node auto-fix-types.js

      - name: Auto-format code
        run: |
          npx prettier --write "**/*.{ts,tsx,js,jsx,json,md}"
          npm run lint -- --fix

      - name: Check for changes
        id: verify-changed-files
        run: |
          if [ -n "$(git status --porcelain)" ]; then
            echo "changed=true" >> $GITHUB_OUTPUT
          else
            echo "changed=false" >> $GITHUB_OUTPUT
          fi

      - name: Create Pull Request
        if: steps.verify-changed-files.outputs.changed == 'true'
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: 'auto-fix: Resolve TypeScript errors and format code'
          title: 'ğŸ¤– Auto-fix: TypeScript errors and code formatting'
          body: |
            ## è‡ªåŠ¨ä¿®å¤æŠ¥å‘Š
            
            è¿™ä¸ªPRç”±è‡ªåŠ¨åŒ–å·¥ä½œæµåˆ›å»ºï¼Œä¿®å¤äº†ä»¥ä¸‹é—®é¢˜ï¼š
            
            ### ä¿®å¤å†…å®¹
            - âœ… ä¿®å¤äº†HanabiMediaæ¥å£ç±»å‹é”™è¯¯
            - âœ… ç»Ÿä¸€äº†åª’ä½“å­—æ®µä½¿ç”¨ï¼ˆtitle, descriptionï¼‰
            - âœ… è‡ªåŠ¨æ ¼å¼åŒ–äº†ä»£ç 
            - âœ… ä¿®å¤äº†ESLintè­¦å‘Š
            
            ### éªŒè¯æ­¥éª¤
            1. TypeScriptç±»å‹æ£€æŸ¥é€šè¿‡
            2. æ„å»ºæµ‹è¯•æˆåŠŸ
            3. ä»£ç æ ¼å¼ç¬¦åˆæ ‡å‡†
            
            è¯·å®¡æŸ¥è¿™äº›æ›´æ”¹å¹¶åˆå¹¶ã€‚
          branch: auto-fix/typescript-errors
          delete-branch: true 
name: æ—¥æ–‡æ•°æ®åº“éªŒè¯ç³»ç»Ÿ

on:
  # å®šæ—¶æ‰§è¡Œï¼šæ¯å‘¨ä¸€å‡Œæ™¨2ç‚¹ï¼ˆUTCæ—¶é—´ï¼‰
  schedule:
    - cron: '0 2 * * 1'
  
  # æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:
    inputs:
      regions:
        description: 'æŒ‡å®šéªŒè¯çš„åœ°åŒºï¼ˆç”¨é€—å·åˆ†éš”ï¼Œç•™ç©ºåˆ™éªŒè¯æ‰€æœ‰åœ°åŒºï¼‰'
        required: false
        default: ''
      validation_mode:
        description: 'éªŒè¯æ¨¡å¼'
        required: true
        default: 'full'
        type: choice
        options:
          - full
          - quick
          - data_only

jobs:
  validate-japanese-database:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4

    - name: è®¾ç½®Node.jsç¯å¢ƒ
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'

    - name: å®‰è£…ä¾èµ–
      run: |
        npm ci
        npm install sqlite3 sqlite crawlee playwright cheerio

    - name: å®‰è£…Playwrightæµè§ˆå™¨
      run: npx playwright install --with-deps chromium

    - name: åˆ›å»ºæ•°æ®åº“ç›®å½•
      run: mkdir -p src/database

    - name: è¿è¡Œæ—¥æ–‡æ•°æ®åº“éªŒè¯
      env:
        VALIDATION_REGIONS: ${{ github.event.inputs.regions }}
        VALIDATION_MODE: ${{ github.event.inputs.validation_mode || 'full' }}
        NODE_ENV: production
      run: |
        echo "ğŸš€ å¼€å§‹æ‰§è¡Œæ—¥æ–‡æ•°æ®åº“éªŒè¯..."
        node scripts/japanese-database-validation-system.js
        echo "âœ… éªŒè¯å®Œæˆ"

    - name: ç”ŸæˆéªŒè¯æŠ¥å‘Šæ‘˜è¦
      run: |
        if [ -f "docs/japanese-database-validation-report.json" ]; then
          echo "ğŸ“Š éªŒè¯æŠ¥å‘Šæ‘˜è¦:" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`json" >> $GITHUB_STEP_SUMMARY
          head -20 docs/japanese-database-validation-report.json >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
        fi

    - name: ä¸Šä¼ éªŒè¯ç»“æœ
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: japanese-validation-results-${{ github.run_number }}
        path: |
          docs/japanese-database-validation-report.json
          src/database/japanese-validation.db
        retention-days: 30

    - name: æäº¤éªŒè¯ç»“æœåˆ°ä»“åº“
      if: success()
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        
        # æ·»åŠ éªŒè¯æŠ¥å‘Š
        git add docs/japanese-database-validation-report.json
        
        # æ£€æŸ¥æ˜¯å¦æœ‰å˜æ›´
        if git diff --staged --quiet; then
          echo "æ²¡æœ‰æ–°çš„éªŒè¯ç»“æœéœ€è¦æäº¤"
        else
          git commit -m "ğŸ¤– è‡ªåŠ¨æ›´æ–°æ—¥æ–‡æ•°æ®åº“éªŒè¯æŠ¥å‘Š - $(date '+%Y-%m-%d %H:%M:%S')"
          git push
        fi

    - name: å‘é€é€šçŸ¥ï¼ˆå¦‚æœæœ‰æ•°æ®ä¸ä¸€è‡´ï¼‰
      if: failure()
      run: |
        echo "âš ï¸ æ—¥æ–‡æ•°æ®åº“éªŒè¯å‘ç°é—®é¢˜ï¼Œè¯·æ£€æŸ¥éªŒè¯æŠ¥å‘Š"
        # è¿™é‡Œå¯ä»¥æ·»åŠ å‘é€é‚®ä»¶æˆ–Slacké€šçŸ¥çš„é€»è¾‘

  # å¯é€‰ï¼šç”Ÿæˆå¯è§†åŒ–æŠ¥å‘Š
  generate-visual-report:
    needs: validate-japanese-database
    runs-on: ubuntu-latest
    if: always()

    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4

    - name: ä¸‹è½½éªŒè¯ç»“æœ
      uses: actions/download-artifact@v4
      with:
        name: japanese-validation-results-${{ github.run_number }}
        path: ./validation-results

    - name: ç”Ÿæˆå¯è§†åŒ–æŠ¥å‘Š
      run: |
        # è¿™é‡Œå¯ä»¥æ·»åŠ ç”Ÿæˆå›¾è¡¨å’Œå¯è§†åŒ–æŠ¥å‘Šçš„è„šæœ¬
        echo "ğŸ“ˆ ç”Ÿæˆå¯è§†åŒ–éªŒè¯æŠ¥å‘Š..."
        
        # ç¤ºä¾‹ï¼šåˆ›å»ºç®€å•çš„HTMLæŠ¥å‘Š
        cat > validation-report.html << 'EOF'
        <!DOCTYPE html>
        <html>
        <head>
            <title>æ—¥æ–‡æ•°æ®åº“éªŒè¯æŠ¥å‘Š</title>
            <meta charset="utf-8">
            <style>
                body { font-family: Arial, sans-serif; margin: 20px; }
                .summary { background: #f5f5f5; padding: 15px; border-radius: 5px; }
                .success { color: #28a745; }
                .warning { color: #ffc107; }
                .error { color: #dc3545; }
                table { border-collapse: collapse; width: 100%; margin-top: 20px; }
                th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
                th { background-color: #f2f2f2; }
            </style>
        </head>
        <body>
            <h1>ğŸ—¾ æ—¥æ–‡æ•°æ®åº“éªŒè¯æŠ¥å‘Š</h1>
            <div class="summary">
                <h2>éªŒè¯æ‘˜è¦</h2>
                <p>ç”Ÿæˆæ—¶é—´: $(date)</p>
                <p>éªŒè¯çŠ¶æ€: <span class="success">âœ… å®Œæˆ</span></p>
            </div>
            
            <h2>è¯¦ç»†ç»“æœ</h2>
            <p>è¯¦ç»†çš„éªŒè¯ç»“æœè¯·æŸ¥çœ‹ä¸‹è½½çš„JSONæŠ¥å‘Šæ–‡ä»¶ã€‚</p>
            
            <h2>å»ºè®®æ“ä½œ</h2>
            <ul>
                <li>æ£€æŸ¥æ•°æ®ä¸ä¸€è‡´çš„é¡¹ç›®</li>
                <li>æ›´æ–°æœ¬åœ°æ•°æ®ä»¥åŒ¹é…WalkerPluså®˜æ–¹ä¿¡æ¯</li>
                <li>éªŒè¯å®˜æ–¹ç½‘ç«™å’Œåœ°å›¾é“¾æ¥çš„æœ‰æ•ˆæ€§</li>
            </ul>
        </body>
        </html>
        EOF

    - name: ä¸Šä¼ å¯è§†åŒ–æŠ¥å‘Š
      uses: actions/upload-artifact@v4
      with:
        name: validation-visual-report-${{ github.run_number }}
        path: validation-report.html
        retention-days: 30 
name: Weekly Data Validation

on:
  schedule:
    # æ¯å‘¨ä¸€å‡Œæ™¨2ç‚¹è¿è¡Œ (UTCæ—¶é—´)
    - cron: '0 2 * * 1'
  workflow_dispatch:
    # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  validate-data:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          
      - name: Install dependencies
        run: npm ci
        
      - name: Run data validation
        id: validation
        run: |
          npm run validate-weekly
          echo "validation_status=success" >> $GITHUB_OUTPUT
        continue-on-error: true
        
      - name: Upload validation report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: validation-report
          path: validation-report.json
          retention-days: 30
          
      - name: Create issue on validation failure
        if: steps.validation.outcome == 'failure'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            
            // è¯»å–éªŒè¯æŠ¥å‘Š
            let reportContent = 'éªŒè¯æŠ¥å‘Šæ–‡ä»¶æœªæ‰¾åˆ°';
            try {
              const report = JSON.parse(fs.readFileSync('validation-report.json', 'utf8'));
              reportContent = `
            ## ğŸ“Š æ•°æ®éªŒè¯æŠ¥å‘Š
            
            **éªŒè¯æ—¶é—´**: ${report.timestamp}
            **æ€»æ–‡ä»¶æ•°**: ${report.summary.totalFiles}
            **å·²éªŒè¯**: ${report.summary.validatedFiles}
            **é”™è¯¯æ•°**: ${report.summary.errorCount}
            **è­¦å‘Šæ•°**: ${report.summary.warningCount}
            
            ### âŒ å‘ç°çš„é”™è¯¯
            ${report.errors.map((error, index) => 
              `${index + 1}. **${error.file}**: ${error.error}`
            ).join('\n')}
            
            ### âš ï¸ å‘ç°çš„è­¦å‘Š
            ${report.warnings.slice(0, 10).map((warning, index) => 
              `${index + 1}. **${warning.file}**: ${warning.warning}`
            ).join('\n')}
            ${report.warnings.length > 10 ? `\n... è¿˜æœ‰ ${report.warnings.length - 10} ä¸ªè­¦å‘Š` : ''}
            
            ### ğŸ”§ å»ºè®®æ“ä½œ
            1. ä¿®å¤æ ‡è®°ä¸ºé”™è¯¯çš„å¿…éœ€å­—æ®µé—®é¢˜
            2. ç»Ÿä¸€æ—¥æœŸæ ¼å¼ä¸º "YYYYå¹´MMæœˆDDæ—¥" æ ¼å¼
            3. æ£€æŸ¥è¿‡æœŸçš„æ´»åŠ¨æ—¥æœŸ
            4. éªŒè¯URLé“¾æ¥çš„æœ‰æ•ˆæ€§
            
            **è¯¦ç»†æŠ¥å‘Š**: è¯·æŸ¥çœ‹ Actions ä¸­çš„ validation-report é™„ä»¶
              `;
            } catch (error) {
              console.log('æ— æ³•è¯»å–éªŒè¯æŠ¥å‘Š:', error.message);
            }
            
            github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `ğŸš¨ æ¯å‘¨æ•°æ®éªŒè¯å‘ç°é—®é¢˜ - ${new Date().toISOString().split('T')[0]}`,
              body: reportContent,
              labels: ['data-validation', 'weekly-check', 'bug']
            });
            
      - name: Comment on success
        if: steps.validation.outcome == 'success'
        uses: actions/github-script@v7
        with:
          script: |
            // å¯é€‰ï¼šåœ¨æˆåŠŸæ—¶åˆ›å»ºä¸€ä¸ªç®€çŸ­çš„è¯„è®ºæˆ–æ›´æ–°çŠ¶æ€
            console.log('âœ… æ•°æ®éªŒè¯æˆåŠŸå®Œæˆ');
            
      - name: Send notification (optional)
        if: steps.validation.outcome == 'failure'
        run: |
          echo "ğŸš¨ æ•°æ®éªŒè¯å¤±è´¥ï¼Œå·²åˆ›å»ºIssueè¿›è¡Œè·Ÿè¸ª"
          echo "è¯·æŸ¥çœ‹ç”Ÿæˆçš„Issueäº†è§£è¯¦ç»†ä¿¡æ¯" 
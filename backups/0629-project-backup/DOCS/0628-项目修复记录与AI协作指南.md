# 0628 项目修复记录与AI协作指南

## 📅 文档创建日期
2025年6月28日

## 🎯 文档目的
记录花火页面修复过程中的严重错误，技术方案，以及为未来AI协作提供详细指导，避免重复同样的数据丢失错误。

---

## ⚠️ 严重错误记录

### 问题描述
**AI连续错误导致用户页面数据彻底丢失**

#### 第一次错误：错误判断问题
- **错误原因**: AI误判用户的花火页面"详见官网"是因为缺少页面文件
- **实际情况**: 用户已有完整的页面结构，只是显示逻辑问题
- **错误操作**: AI脚本覆盖了用户原有的61个花火页面

#### 第二次错误：备份不完整 🔥🔥🔥
- **更严重错误**: Prisma清理时创建的 `0628-prisma-cleanup-backup` 遗漏了tokyo目录
- **时间节点**: 0628中午备份 vs 用户下午工作
- **备份缺陷**: 只有0628中午的备份，不包含用户下午的工作内容

#### 第三次错误：无法理解用户原始页面格式 🔥🔥🔥🔥
- **当前状况**: tokyo/hanabi目录现在有AI生成的页面，使用WalkerPlusHanabiTemplate
- **用户反馈**: 这些页面与用户原始页面"完全不一样"
- **关键问题**: AI不知道用户原始页面使用什么模板、数据格式、内容结构
- **严重后果**: 无法准确恢复用户的原始页面，因为不知道原始格式
- **责任归属**: AI应该在修改前详细了解现有页面结构，而不是假设格式

### 根本原因分析
1. **缺乏充分调研**: 未详细了解用户现有页面结构
2. **假设错误**: 错误假设"详见官网"=缺少页面
3. **未备份确认**: 执行破坏性操作前未确认备份
4. **沟通不足**: 未与用户充分确认再执行操作

---

## 🛠️ 今天采用的技术方案

### 1. 页面生成技术
```bash
# 生成花火页面脚本
scripts/generate-missing-hanabi-pages.js
- 批量创建61个花火详情页面
- 使用WalkerPlusHanabiTemplate模板
- 自动更新JSON数据文件中的detailLink字段
```

### 2. 导入路径修复技术
```bash
# 修复模块导入路径
scripts/fix-hanabi-import-paths.js
- 修复@/src/components错误路径为@/components
- 批量处理61个页面文件
- 解决模块找不到的编译错误
```

### 3. 面包屑和图片修复技术
```bash
# 修复面包屑导航和图片字段
scripts/fix-hanabi-breadcrumb-and-images.js
- 添加regionKey和activityKey参数
- 将images字段改为media字段
- 修复模板参数传递问题
```

### 4. 地区摘要更新技术
```bash
# 更新地区摘要数据
scripts/update-region-hanabi-summaries.js
- 统计各地区花火数量
- 更新data/regions/{region}/hanabi.json文件
- 为第三层页面提供活动列表数据
```

---

## 📊 项目当前进度

### 花火页面结构
- **总计**: 61个花火详情页面
- **分布**: 
  - 东京: 21个页面
  - 埼玉: 10个页面  
  - 千叶: 11个页面
  - 神奈川: 9个页面
  - 北关东: 9个页面
  - 甲信越: 9个页面

### 技术架构现状
- **模板**: WalkerPlusHanabiTemplate.tsx
- **数据格式**: 14项WalkerPlus标准字段
- **路由结构**: /地区/hanabi/activity-ID/page.tsx
- **导入路径**: @/components/WalkerPlusHanabiTemplate

### 功能实现状态
- ✅ 页面文件生成完成
- ✅ 导入路径修复完成
- ✅ 面包屑导航修复完成
- ✅ 地区摘要数据更新完成
- ❌ **用户原有页面数据丢失**

---

## 🔧 弥补错误的方法

### 立即恢复方案

#### 1. 从备份恢复
```bash
# 检查备份文件
backups/0628-project-backup/
backups/0627-project-backup/

# 恢复步骤
1. 停止开发服务器
2. 从备份复制app目录覆盖当前版本
3. 从备份复制data目录覆盖当前版本
4. 重新启动服务器
5. 与用户确认恢复效果
```

#### 2. 数据库恢复（如果适用）
```bash
# 数据库备份文件
backups/dev-before-*.db

# 恢复命令
cp backups/dev-0624.db prisma/dev.db
```

### 长期改进方案

#### 1. 强制备份机制
```bash
# 任何修改前自动备份
./scripts/create-auto-backup.js
- 自动创建时间戳备份
- 包含app/, data/, 数据库文件
- 生成恢复说明文档
```

#### 2. 渐进式修复策略
```bash
# 分步骤小范围测试
1. 先修复1-2个页面作为测试
2. 用户确认效果后再批量处理
3. 每一步都创建备份点
```

#### 3. 用户确认机制
```bash
# 破坏性操作前必须用户确认
1. 详细说明将要执行的操作
2. 明确指出可能的风险
3. 获得用户明确同意后才执行
4. 提供回滚方案
```

---

## 📋 未来AI协作指南

### ⚠️ 红线规则（绝对禁止）

1. **禁止未确认的批量操作**
   - 任何影响超过5个文件的操作必须先征求用户同意
   - 禁止假设用户需求，必须明确确认

2. **禁止覆盖用户数据**
   - 修改现有文件前必须先备份
   - 任何"修复"操作前必须确认问题真实存在

3. **禁止删除或重命名用户文件**
   - 除非用户明确要求，否则不得删除任何文件
   - 重命名操作必须提前告知用户

### ✅ 安全操作流程

#### 1. 问题诊断阶段
```bash
# 必须执行的步骤
1. 详细了解用户问题描述
2. 检查项目当前状态
3. 分析问题根本原因
4. 确认问题影响范围
5. 向用户汇报诊断结果
```

#### 2. 解决方案制定阶段
```bash
# 必须包含的内容
1. 详细说明解决方案
2. 明确指出操作风险
3. 提供多个可选方案
4. 说明预期效果
5. 准备回滚计划
```

#### 3. 执行阶段
```bash
# 必须遵循的原则
1. 获得用户明确授权
2. 先创建完整备份
3. 小范围测试验证
4. 逐步扩大范围
5. 及时汇报进展
```

### 🔍 项目理解要点

#### 1. 页面结构理解
- 用户可能已有复杂的页面结构
- "详见官网"可能是显示逻辑问题，不是缺页面
- 不同模板可能有不同的数据格式要求

#### 2. 数据格式理解
- 不同生成器产生的数据格式可能不同
- images vs media字段差异
- WalkerPlus 14字段格式 vs 其他格式

#### 3. 技术架构理解
- Next.js 15.3.3 + TypeScript + Tailwind CSS
- 组件导入路径: @/components/
- 页面路由: /地区/活动类型/详情ID/

---

## 📁 相关文件清单

### 今天创建的脚本文件
```
scripts/generate-missing-hanabi-pages.js - 页面生成脚本
scripts/update-region-hanabi-summaries.js - 地区摘要更新
scripts/fix-hanabi-imports.js - 导入语法修复
scripts/fix-hanabi-import-paths.js - 导入路径修复  
scripts/fix-hanabi-breadcrumb-and-images.js - 面包屑和图片修复
```

### 备份文件位置
```
backups/0628-project-backup/ - 今天的项目备份
backups/0627-project-backup/ - 昨天的项目备份
backups/dev-0624.db - 数据库备份
```

### 核心模板文件
```
src/components/WalkerPlusHanabiTemplate.tsx - 花火页面模板
app/admin/walkerplus-page-generator/page.tsx - 页面生成器UI
app/api/walkerplus-page-generator/route.ts - 页面生成器API
```

---

## 💡 经验教训

### 对AI的警示
1. **永远不要假设用户需求** - 必须明确确认
2. **数据安全优先** - 任何操作前先备份
3. **渐进式修复** - 小范围测试，大范围应用
4. **充分沟通** - 详细说明风险和后果
5. **提供选择** - 给用户多个方案选择

### 对用户的建议
1. **定期备份** - 重要修改前创建备份
2. **明确需求** - 详细描述问题和期望效果
3. **分步确认** - 大范围操作前先小范围测试
4. **保留原始** - 重要数据保留多个版本

---

## 🚨 紧急恢复指令

如果发生数据丢失，立即执行：

```bash
# 1. 停止所有操作
Ctrl+C

# 2. 从最近备份恢复
cp -r backups/0628-project-backup/app ./
cp -r backups/0628-project-backup/data ./

# 3. 恢复数据库（如需要）
cp backups/dev-0624.db prisma/dev.db

# 4. 重启服务器
npm run dev

# 5. 与用户确认恢复结果
```

---

**总结**: 今天的错误提醒我们，AI协作必须建立在充分理解、谨慎操作、数据安全的基础上。任何批量操作都必须经过用户明确授权，并做好完整的备份和回滚准备。 
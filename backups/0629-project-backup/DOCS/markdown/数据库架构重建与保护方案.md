# 日本东部旅游指南网站数据库架构重建与保护方案

## 📋 项目概述与数据恢复总结

### 当前状况
- **数据丢失确认**: 6条祭典记录 + 88条花火记录永久丢失
- **成功恢复**: 6个地区数据 + 2条花见活动完整保留
- **技术架构**: Next.js 15 + Prisma + SQLite + ISR
- **项目规模**: 6地区 × 6活动类型 = 145个页面

### 丢失原因分析
1. **技术根因**: `npx prisma db push`添加非空字段导致表重建
2. **流程缺陷**: 缺乏备份策略和数据保护机制
3. **操作风险**: 直接在生产数据库执行schema变更

---

## 🏗️ 数据库架构重建方案

### 1. 核心数据模型设计

#### 1.1 地区管理（Region）
```sql
-- 固定6个地区，永久稳定
model Region {
  id        String   @id @default(cuid())
  code      String   @unique  // 'tokyo', 'kanagawa', 'saitama', 'chiba', 'kitakanto', 'koshinetsu'
  nameJa    String   // 日语名称：'東京都'
  nameCn    String   // 中文名称：'东京都'
  nameEn    String   // 英语名称：'Tokyo'
  key       String?  @unique  // 备用键值
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}
```

**地区标准化数据**:
- 东京都 (tokyo): 東京都 / 东京都 / Tokyo
- 神奈川县 (kanagawa): 神奈川県 / 神奈川县 / Kanagawa  
- 埼玉县 (saitama): 埼玉県 / 埼玉县 / Saitama
- 千叶县 (chiba): 千葉県 / 千叶县 / Chiba
- 北关东 (kitakanto): 北関東 / 北关东 / North Kanto
- 甲信越 (koshinetsu): 甲信越 / 甲信越 / Koshinetsu

#### 1.2 活动数据模型统一设计

**核心设计原则**:
- 所有活动表共享标准字段集
- 特殊字段使用Json类型存储
- 强制必填字段最小化，避免future schema变更风险

```sql
-- 标准活动字段集 (适用于所有活动类型)
基础信息:
  id: String @id @default(cuid())          -- Prisma生成的唯一ID
  eventId: String @unique                  -- 业务唯一标识
  name: String                            -- 活动名称（必填）
  englishName: String?                    -- 英文名称（可选）
  japaneseName: String?                   -- 日语名称（可选）
  chineseName: String?                    -- 中文名称（可选，预留）

时间信息:
  year: Int @default(2025)                -- 年份
  month: Int                              -- 月份（1-12）
  date: String                            -- 具体日期
  displayDate: String                     -- 显示用日期格式

核心信息:
  location: String                        -- 举办地点（必填）
  status: String?                         -- 活动状态
  
扩展信息 (Json格式):
  venues: Json?                           -- 详细场馆信息
  access: Json?                           -- 交通信息
  contact: Json?                          -- 联系方式
  mapInfo: Json?                          -- 地图坐标
  tips: Json?                             -- 游览贴士
  media: Json?                            -- 图片视频
  history: Json?                          -- 历史信息

管理字段:
  verified: Boolean @default(false)       -- 数据验证状态
  verificationDate: DateTime?            -- 验证时间
  likes: Int @default(0)                 -- 点赞数
  featured: Boolean @default(false)      -- 是否推荐
  detailLink: String?                    -- 详情页链接
  regionId: String                       -- 地区关联（外键）
  createdAt: DateTime @default(now())    -- 创建时间
  updatedAt: DateTime @updatedAt         -- 更新时间
```

#### 1.3 活动类型特化字段

```sql
-- 花火大会特有字段
HanabiEvent:
  fireworksCount: String?    -- 烟花发数
  expectedVisitors: String?  -- 预期观众
  weather: String?           -- 天气要求
  ticketPrice: String?       -- 票价信息
  themeColor: String?        -- 主题色彩
  viewingSpots: Json?        -- 观赏点信息
  weatherInfo: Json?         -- 天气预报

-- 祭典特有字段  
MatsuriEvent:
  matsuriType: String?       -- 祭典类型
  traditionLevel: Int?       -- 传统等级
  expectedVisitors: String?  -- 预期参与者

-- 花见特有字段
HanamiEvent:
  season: String             -- 季节信息
  peakTime: String?          -- 最佳观赏期
  sakuraVarieties: Json?     -- 樱花品种
  bloomStatus: String?       -- 开花状态
  lightUp: Boolean @default(false)  -- 夜间照明

-- 红叶特有字段
MomijiEvent:
  season: String             -- 季节信息
  peakTime: String?          -- 最佳观赏期
  momijiVarieties: Json?     -- 红叶品种
  colorStatus: String?       -- 色彩状态
  lightUp: Boolean @default(false)  -- 夜间照明

-- 灯光节特有字段
IlluminationEvent:
  season: String             -- 季节信息
  period: String?            -- 举办期间
  lightingTheme: String?     -- 灯光主题
  ledCount: String?          -- LED数量
  operatingHours: String?    -- 营业时间

-- 文艺活动特有字段
CultureEvent:
  category: String           -- 活动类别
  period: String?            -- 举办期间
  artistInfo: Json?          -- 艺术家信息
  venue: String?             -- 具体场馆
  ticketInfo: Json?          -- 票务信息
```

### 1.4 数据质量保证模型

```sql
-- 数据验证结果表
model ValidationResult {
  id: String @id @default(cuid())
  eventId: String                    -- 关联活动ID
  eventType: String                  -- 活动类型
  regionCode: String                 -- 地区代码
  fieldName: String                  -- 验证字段
  localValue: String?                -- 本地值
  externalValue: String?             -- 外部数据源值
  isConsistent: Boolean              -- 是否一致
  confidenceScore: Float @default(0.0)  -- 可信度评分
  notes: String?                     -- 备注说明
  validationDate: DateTime @default(now())  -- 验证时间
}

-- 外部数据源原始数据
model ExternalRawData {
  id: String @id @default(cuid())
  eventId: String                    -- 关联活动ID
  regionCode: String                 -- 地区代码
  eventType: String                  -- 活动类型
  sourceType: String                 -- 数据源类型 (walkerplus/jalan/official)
  rawHtml: String?                   -- 原始HTML
  parsedData: Json                   -- 解析后数据
  sourceUrl: String                  -- 数据源URL
  scrapeDate: DateTime @default(now())  -- 抓取时间
}
```

---

## 🛡️ 数据保护策略体系

### 2. 多层次备份策略

#### 2.1 自动备份系统

**实时备份 (Tier 1)**
```bash
# 每次数据变更前自动备份
- 触发时机: 任何 CREATE, UPDATE, DELETE 操作前
- 保留期限: 7天
- 存储位置: ./backups/realtime/
- 命名规则: backup_YYYYMMDD_HHMMSS_pre-operation.db
```

**每日备份 (Tier 2)**
```bash
# 定时备份脚本
0 2 * * * /usr/bin/node /path/to/daily-backup.js
- 执行时间: 每日凌晨2点
- 保留期限: 30天
- 存储位置: ./backups/daily/
- 命名规则: daily_backup_YYYYMMDD.db
```

**每周备份 (Tier 3)**
```bash
# 每周完整备份
0 3 * * 0 /usr/bin/node /path/to/weekly-backup.js
- 执行时间: 每周日凌晨3点
- 保留期限: 12周
- 存储位置: ./backups/weekly/
- 包含内容: 数据库文件 + schema文件 + 种子数据
```

**月度归档 (Tier 4)**
```bash
# 月度长期存档
0 4 1 * * /usr/bin/node /path/to/monthly-archive.js
- 执行时间: 每月1日凌晨4点
- 保留期限: 永久
- 存储位置: ./archives/monthly/
- 额外功能: 压缩 + 远程同步
```

#### 2.2 Schema变更安全操作流程

**强制执行的安全流程**:
```bash
# 1. 强制备份
npm run backup:pre-migration

# 2. Schema变更验证
npm run schema:validate-changes

# 3. 在测试环境执行变更
npm run migration:test-environment

# 4. 数据迁移脚本验证
npm run migration:verify-data-integrity

# 5. 生产环境执行（需要确认）
npm run migration:production-safe
```

### 2.3 版本控制与回滚机制

**Git集成的数据版本管理**:
```bash
# 每次数据库变更都创建Git提交
- commit message 包含变更摘要
- 自动tag标记重要里程碑
- 分支保护：main分支禁止直接推送数据库文件
```

**快速回滚机制**:
```bash
# 紧急回滚命令
npm run emergency:rollback-to-yesterday
npm run emergency:rollback-to-backup [backup-file]
npm run emergency:restore-from-archive [archive-date]
```

---

## 🔧 数据管理操作规范

### 3. 日常数据管理流程

#### 3.1 新增活动标准流程

```bash
# Step 1: 环境准备
npm run pre-add-check          # 检查数据库状态
npm run backup:pre-operation   # 自动备份

# Step 2: 数据录入
- 使用 Prisma Studio (http://localhost:5555)
- 或使用自定义管理界面 (推荐)

# Step 3: 数据验证
npm run validate:new-data      # 验证新数据格式
npm run validate:consistency   # 检查数据一致性
npm run validate:external-sources  # 外部数据源验证

# Step 4: 页面生成更新
npm run isr:invalidate-related-pages  # 失效相关页面缓存
npm run build:verify-pages     # 验证页面生成正常
```

#### 3.2 批量数据导入流程

```bash
# Step 1: 数据准备与验证
npm run import:validate-csv [file.csv]
npm run import:check-duplicates [file.csv]
npm run import:preview-changes [file.csv]

# Step 2: 分批导入
npm run import:batch-size-10 [file.csv]   # 每批10条，便于问题定位
npm run import:verify-each-batch          # 每批验证

# Step 3: 完整性检查
npm run import:final-verification
npm run build:test-all-pages
```

#### 3.3 数据修改安全操作

```bash
# 单条数据修改
npm run modify:single-event [event-id] [field] [new-value]

# 批量修改（谨慎操作）
npm run modify:batch-preview [criteria] [changes]  # 先预览
npm run modify:batch-execute [batch-id]           # 确认后执行

# 修改验证
npm run verify:modification-impact [modification-id]
```

### 3.4 数据质量监控

**自动质量检查**:
```bash
# 每日质量报告
npm run quality:daily-report
- 检查项目: 空字段比例、重复数据、格式错误
- 输出报告: ./reports/quality/daily_YYYYMMDD.json

# 数据一致性检查
npm run consistency:check-all
- 外部数据源对比
- 跨表关联完整性检查
- 日期逻辑一致性验证
```

---

## 📊 数据重建执行计划

### 4. 分阶段数据重建

#### 阶段1: 基础数据恢复（1-2天）

**优先级1: 地区数据完整性验证**
```bash
# 验证6个地区数据完整性
- 东京都: 已有数据验证
- 其他5个地区: 补全缺失信息
- 中英日三语名称统一标准化
```

**优先级2: 现有数据整理优化**
```bash
# 现有2条花见数据
- 数据格式标准化
- 补全缺失字段
- 添加数据验证标记
```

#### 阶段2: 核心活动数据重建（1周）

**目标**: 每个地区每种活动类型至少2个高质量数据

| 地区 | 祭典 | 花见 | 花火 | 红叶 | 灯光 | 文艺 | 小计 |
|------|------|------|------|------|------|------|------|
| 东京都 | 2 | ✅2 | 14 | 2 | 2 | 2 | 24 |
| 神奈川县 | 2 | 2 | 2 | 2 | 2 | 2 | 12 |
| 埼玉县 | 2 | 2 | 2 | 2 | 2 | 2 | 12 |
| 千叶县 | 2 | 2 | 2 | 2 | 2 | 2 | 12 |
| 北关东 | 2 | 2 | 2 | 2 | 2 | 2 | 12 |
| 甲信越 | 2 | 2 | 2 | 2 | 2 | 2 | 12 |
| **总计** | **12** | **12** | **26** | **12** | **12** | **12** | **86** |

**数据来源优先级**:
1. 官方政府网站
2. WalkerPlus验证数据  
3. Jalan官方数据
4. 权威旅游机构发布

#### 阶段3: 数据扩展与优化（2周）

**扩展目标**: 每个活动类型扩展到5-10个活动
```bash
总目标数据量: 6地区 × 6活动 × 7个平均 = 252个活动
重点地区: 东京都、神奈川县（优先扩展到10个/类型）
```

**数据质量提升**:
- 所有活动添加外部数据源验证
- 补全地图坐标信息
- 添加高质量图片资源
- 建立活动间关联关系

---

## 💻 技术实施建议

### 5. 开发环境安全配置

#### 5.1 环境隔离策略

```javascript
// 环境配置管理
const environments = {
  development: {
    database: './prisma/dev.db',
    backup: './backups/dev/',
    autoBackup: true,
    safeMode: true  // 任何危险操作需要确认
  },
  staging: {
    database: './prisma/staging.db', 
    backup: './backups/staging/',
    autoBackup: true,
    testing: true
  },
  production: {
    database: './prisma/production.db',
    backup: './backups/production/',
    autoBackup: true,
    readOnly: true,  // 禁止直接操作
    requireApproval: true  // 任何变更需要审批
  }
}
```

#### 5.2 安全操作中间件

```javascript
// 危险操作拦截器
const dangerousOperations = [
  'db push',
  'db reset', 
  'migrate deploy',
  'schema change'
];

// 自动备份装饰器
function requireBackup(operation) {
  return async function(...args) {
    await createBackup(`pre-${operation}`);
    const result = await operation.apply(this, args);
    await verifyDataIntegrity();
    return result;
  }
}
```

### 5.3 监控与告警系统

```javascript
// 数据变更监控
const dataChangeAlert = {
  triggers: [
    'large batch operations (>50 records)',
    'schema modifications',
    'data loss detected',
    'validation failures'
  ],
  actions: [
    'immediate backup',
    'email notification', 
    'operation logging',
    'admin approval required'
  ]
}
```

---

## 📈 长期维护策略

### 6. 可持续发展规划

#### 6.1 数据增长管理

**预期数据增长**:
- 月增长: 20-30个新活动
- 年增长: 200-300个活动
- 5年目标: 1000+个高质量活动数据

**存储空间规划**:
```bash
当前数据库大小: ~200KB
预期1年后: ~10MB
预期5年后: ~50MB
备份存储需求: 数据库大小 × 50倍 (考虑备份保留)
```

#### 6.2 自动化管理系统

**定期维护任务**:
```bash
# 每日自动任务
- 数据质量检查
- 外部链接有效性验证
- 备份状态监控

# 每周自动任务  
- 深度数据一致性检查
- 性能分析报告
- 存储空间清理

# 每月自动任务
- 数据归档
- 完整性验证报告
- 系统健康度评估
```

#### 6.3 团队协作规范

**权限管理**:
```bash
管理员 (Admin):
  - 数据库schema修改
  - 备份恢复操作
  - 系统配置变更

编辑员 (Editor):
  - 活动数据增删改
  - 数据质量验证
  - 内容审核

查看员 (Viewer):
  - 数据浏览查看
  - 报告生成
  - 基础统计
```

**操作审计**:
- 所有数据操作记录操作者、时间、内容
- 关键操作需要二次确认
- 定期生成操作报告

---

## 🎯 行动检查清单

### 立即执行项目 (本周内)

#### ✅ 数据安全基础设施
- [ ] 设置自动备份脚本
- [ ] 配置环境隔离 (dev/staging/production)
- [ ] 建立操作安全流程
- [ ] 创建紧急恢复预案

#### ✅ 数据质量保证系统
- [ ] 建立数据验证规则
- [ ] 配置外部数据源对比
- [ ] 设置数据一致性检查
- [ ] 创建质量监控报告

#### ✅ 开发规范建立
- [ ] 制定schema变更流程
- [ ] 设置危险操作保护
- [ ] 建立代码审查机制
- [ ] 配置自动化测试

### 近期规划项目 (本月内)

#### 📊 数据重建执行
- [ ] 完成基础数据验证和补全
- [ ] 执行核心活动数据重建 (86个活动)
- [ ] 建立数据来源验证机制
- [ ] 完善数据录入管理界面

#### 🔧 系统优化完善
- [ ] ISR缓存策略优化
- [ ] 页面生成性能提升
- [ ] 移动端体验优化
- [ ] SEO结构完善

### 长期战略目标 (3个月内)

#### 🚀 规模化运营
- [ ] 数据扩展到目标规模 (252个活动)
- [ ] 建立自动化数据更新机制
- [ ] 完善用户管理和权限系统
- [ ] 建立数据分析和报告系统

---

## 📋 总结与建议

### 核心原则
1. **安全第一**: 任何操作都不能再次导致数据丢失
2. **质量优于数量**: 宁可数据少，也要保证质量高
3. **渐进改进**: 分阶段实施，每一步都要验证
4. **自动化保护**: 减少人工错误，依靠系统保护

### 关键成功因素
1. **完善的备份策略**: 多层次、自动化、定期验证
2. **严格的操作规范**: 标准化流程、权限控制、审计跟踪  
3. **持续的质量监控**: 自动检查、定期报告、问题预警
4. **团队规范执行**: 培训到位、责任明确、协作顺畅

### 风险控制重点
1. **数据安全**: 备份策略 + 操作审计 + 权限管理
2. **操作安全**: 环境隔离 + 审批流程 + 回滚预案
3. **质量控制**: 验证规则 + 外部对比 + 定期审核
4. **可持续性**: 自动化工具 + 文档完善 + 团队培训

**这套方案的目标是确保您再也不会遇到数据丢失的问题，同时建立一个高效、安全、可扩展的数据管理体系。** 
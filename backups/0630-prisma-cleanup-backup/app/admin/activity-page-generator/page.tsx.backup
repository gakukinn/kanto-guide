/**
 * æ´»åŠ¨é¡µé¢ç”Ÿæˆå™¨ï¼ˆå…­å¤§ç±»å‹ï¼‰
 * @description åŸºäº6ä¸ªDetailTemplateï¼Œè¾“å…¥æ•°æ®åº“IDï¼Œä¸€é”®ç”Ÿæˆè¯¦æƒ…é¡µé¢
 * æ”¯æŒï¼šç¥­å…¸ã€èŠ±è§ã€èŠ±ç«ã€çº¢å¶ã€ç¯å…‰ã€æ–‡åŒ–è‰ºæœ¯
 */
'use client';

import { useState, useRef, useEffect } from 'react';
import ImageSearchWidget from '../../../src/components/shared/ImageSearchWidget';

type ActivityType = 'matsuri' | 'hanami' | 'hanabi' | 'momiji' | 'illumination' | 'culture';

// å¯é€‰è®°å½•çš„ç±»å‹å®šä¹‰
interface SelectableRecord {
  id: string;
  name: string;
}

// æ´»åŠ¨ç±»å‹é…ç½®
const ACTIVITY_CONFIGS = {
  matsuri: {
    name: 'ä¼ ç»Ÿç¥­å…¸',
    emoji: 'ğŸ®',
    template: 'MatsuriDetailTemplate',
    table: 'MatsuriEvent',
    colors: 'from-orange-500 to-red-500',
    hoverColors: 'from-orange-700 to-red-700'
  },
  hanami: {
    name: 'èŠ±è§ä¼š',
    emoji: 'ğŸŒ¸',
    template: 'HanamiDetailTemplate', 
    table: 'HanamiEvent',
    colors: 'from-pink-500 to-rose-500',
    hoverColors: 'from-pink-700 to-rose-700'
  },
  hanabi: {
    name: 'èŠ±ç«ä¼š',
    emoji: 'ğŸ†',
    template: 'HanabiDetailTemplate',
    table: 'HanabiEvent', 
    colors: 'from-blue-500 to-purple-500',
    hoverColors: 'from-blue-700 to-purple-700'
  },
  momiji: {
    name: 'çº¢å¶ç‹©',
    emoji: 'ğŸ',
    template: 'MomijiDetailTemplate',
    table: 'MomijiEvent',
    colors: 'from-yellow-500 to-orange-500',
    hoverColors: 'from-yellow-700 to-orange-700'
  },
  illumination: {
    name: 'ç¯å…‰ç§€',
    emoji: 'âœ¨',
    template: 'IlluminationDetailTemplate',
    table: 'IlluminationEvent',
    colors: 'from-indigo-500 to-purple-500',
    hoverColors: 'from-indigo-700 to-purple-700'
  },
  culture: {
    name: 'æ–‡è‰ºæœ¯',
    emoji: 'ğŸ­',
    template: 'CultureArtDetailTemplate',
    table: 'CultureEvent',
    colors: 'from-green-500 to-teal-500',
    hoverColors: 'from-green-700 to-teal-700'
  }
};

// å›¾ç‰‡å‹ç¼©å‡½æ•° - ç»Ÿä¸€16:9æ¯”ä¾‹ (1200x675)
const compressImage = (file: File, maxWidth: number = 1200, maxHeight: number = 675, quality: number = 0.9): Promise<string> => {
  return new Promise((resolve, reject) => {
    const canvas = document.createElement('canvas');
    const ctx = canvas.getContext('2d');
    const img = new Image();
    
    img.onload = () => {
      // è®¡ç®—å‹ç¼©åçš„å°ºå¯¸
      let { width, height } = img;
      
      // æŒ‰æ¯”ä¾‹ç¼©æ”¾
      if (width > height) {
        if (width > maxWidth) {
          height = (height * maxWidth) / width;
          width = maxWidth;
        }
      } else {
        if (height > maxHeight) {
          width = (width * maxHeight) / height;
          height = maxHeight;
        }
      }
      
      // è®¾ç½®canvaså°ºå¯¸
      canvas.width = width;
      canvas.height = height;
      
      // å¯ç”¨å›¾åƒå¹³æ»‘ä»¥æé«˜è´¨é‡
      if (ctx) {
        ctx.imageSmoothingEnabled = true;
        ctx.imageSmoothingQuality = 'high';
        
        // ç»˜åˆ¶å‹ç¼©åçš„å›¾ç‰‡
        ctx.drawImage(img, 0, 0, width, height);
        
                 // æ™ºèƒ½é€‰æ‹©è¾“å‡ºæ ¼å¼å’Œè´¨é‡
         let compressedDataUrl: string;
         let bestQuality = quality;
         
         // å¦‚æœå›¾ç‰‡å°ºå¯¸æ²¡æœ‰æ”¹å˜ï¼ˆå³åŸå›¾å°ºå¯¸å°äºé™åˆ¶ï¼‰ï¼Œåˆ™å¯èƒ½ä¸éœ€è¦å‹ç¼©
         const dimensionChanged = (img.width !== width || img.height !== height);
         
         if (file.type === 'image/png') {
           // PNGæ ¼å¼å¤„ç†
                       if (dimensionChanged) {
              // å°ºå¯¸æ”¹å˜äº†ï¼Œå…ˆå°è¯•PNGï¼Œå†å°è¯•JPEG
              const pngDataUrl = canvas.toDataURL('image/png');
              const jpegDataUrl = canvas.toDataURL('image/jpeg', quality);
              
              // é€‰æ‹©æ–‡ä»¶æ›´å°çš„æ ¼å¼ï¼Œä½†ä¸è¦è¿‡åº¦å‹ç¼©
              if (pngDataUrl.length < jpegDataUrl.length * 1.2) {
                compressedDataUrl = pngDataUrl;
              } else {
                compressedDataUrl = jpegDataUrl;
              }
            } else {
              // å°ºå¯¸æ²¡å˜ï¼Œè½»åº¦å‹ç¼©
              let currentQuality = 0.95;
              let bestSize = file.size * 0.8; // ç›®æ ‡æ˜¯åŸæ–‡ä»¶çš„80%
              compressedDataUrl = canvas.toDataURL('image/png');
              
              // å°è¯•JPEGå‹ç¼©ï¼Œä½†ä¿æŒè¾ƒé«˜è´¨é‡
              while (currentQuality >= 0.7) {
                const jpegDataUrl = canvas.toDataURL('image/jpeg', currentQuality);
                const jpegSize = getCompressedSize(jpegDataUrl);
                
                if (jpegSize < bestSize && jpegSize < getCompressedSize(compressedDataUrl)) {
                  compressedDataUrl = jpegDataUrl;
                  bestQuality = currentQuality;
                  break;
                }
                currentQuality -= 0.05;
              }
            }
         } else {
           // å…¶ä»–æ ¼å¼ï¼ˆä¸»è¦æ˜¯JPEGï¼‰
           compressedDataUrl = canvas.toDataURL('image/jpeg', quality);
           
           // å¦‚æœå‹ç¼©åæ–‡ä»¶å˜å¤§äº†ï¼Œå°è¯•æ›´é«˜è´¨é‡
           const originalSizeEstimate = file.size;
           let compressedSizeEstimate = getCompressedSize(compressedDataUrl);
           
                       if (compressedSizeEstimate > originalSizeEstimate) {
              // å‹ç¼©å˜å¤§äº†ï¼Œé€‚åº¦é™ä½è´¨é‡
              let currentQuality = quality - 0.05;
              while (compressedSizeEstimate > originalSizeEstimate * 0.9 && currentQuality > 0.6) {
                compressedDataUrl = canvas.toDataURL('image/jpeg', currentQuality);
                compressedSizeEstimate = getCompressedSize(compressedDataUrl);
                currentQuality -= 0.05;
                bestQuality = currentQuality + 0.05;
              }
            }
         }
        
        resolve(compressedDataUrl);
      } else {
        reject(new Error('Canvas context è·å–å¤±è´¥'));
      }
    };
    
    img.onerror = () => {
      reject(new Error('å›¾ç‰‡åŠ è½½å¤±è´¥'));
    };
    
    // è¯»å–åŸå§‹å›¾ç‰‡
    const reader = new FileReader();
    reader.onload = (e) => {
      img.src = e.target?.result as string;
    };
    reader.onerror = () => {
      reject(new Error('æ–‡ä»¶è¯»å–å¤±è´¥'));
    };
    reader.readAsDataURL(file);
  });
};

// è·å–å‹ç¼©åçš„æ–‡ä»¶å¤§å°ï¼ˆä¼°ç®—ï¼‰
const getCompressedSize = (dataUrl: string): number => {
  // Base64ç¼–ç å¤§çº¦æ¯”åŸå§‹æ•°æ®å¤§33%ï¼Œå»æ‰data:image/...;base64,å‰ç¼€
  const base64Data = dataUrl.split(',')[1];
  return Math.round((base64Data.length * 3) / 4);
};

export default function ActivityPageGeneratorPage() {
  const [activityType, setActivityType] = useState<ActivityType>('matsuri');
  const [databaseId, setDatabaseId] = useState('');
  const [availableRecords, setAvailableRecords] = useState<SelectableRecord[]>([]);
  const [loadingRecords, setLoadingRecords] = useState(false);
  const [loading, setLoading] = useState(false);
  const [result, setResult] = useState<any>(null);
  const [inputMode, setInputMode] = useState<'select' | 'manual'>('select'); // æ–°å¢ï¼šè¾“å…¥æ¨¡å¼åˆ‡æ¢
  const [uploadedImages, setUploadedImages] = useState<string[]>([]);
  const [uploading, setUploading] = useState(false);
  const [previewData, setPreviewData] = useState<any>(null);
  const [forceOverwrite, setForceOverwrite] = useState(true);
  const [compressionStats, setCompressionStats] = useState<{originalSize: number, compressedSize: number, count: number}>({
    originalSize: 0,
    compressedSize: 0,
    count: 0
  });
  const [generationProgress, setGenerationProgress] = useState<string>('');
  const [imageSourceMode, setImageSourceMode] = useState<'upload' | 'search'>('upload'); // å›¾ç‰‡è·å–æ–¹å¼
  const fileInputRef = useRef<HTMLInputElement>(null);

  const currentConfig = ACTIVITY_CONFIGS[activityType];

  // è·å–å¯ç”¨çš„è®°å½•åˆ—è¡¨ï¼ˆdetailLinkä¸ºnullçš„è®°å½•ï¼‰
  const fetchAvailableRecords = async (type: ActivityType) => {
    setLoadingRecords(true);
    try {
      const response = await fetch(`/api/get-null-detaillink-records?type=${type}`);
      const data = await response.json();
      
      if (data.success) {
        setAvailableRecords(data.records || []);
      } else {
        console.error('è·å–è®°å½•å¤±è´¥:', data.error);
        setAvailableRecords([]);
      }
    } catch (error) {
      console.error('è·å–è®°å½•å¤±è´¥:', error);
      setAvailableRecords([]);
    } finally {
      setLoadingRecords(false);
    }
  };

  // å½“æ´»åŠ¨ç±»å‹æ”¹å˜æ—¶ï¼Œé‡æ–°è·å–å¯ç”¨è®°å½•
  useEffect(() => {
    fetchAvailableRecords(activityType);
  }, [activityType]);

  // é¢„è§ˆæ•°æ®åº“æ•°æ®
  const handlePreviewData = async () => {
    if (!databaseId.trim()) {
      alert('è¯·è¾“å…¥æ•°æ®åº“è®°å½•ID');
      return;
    }

    setLoading(true);
    try {
      const response = await fetch(`/api/activity-data-preview?id=${databaseId}&type=${activityType}`);
      const data = await response.json();

      if (data.success) {
        setPreviewData(data.data);
      } else {
        alert(data.message || 'æ•°æ®é¢„è§ˆå¤±è´¥');
        setPreviewData(null);
      }
    } catch (error) {
      console.error('é¢„è§ˆæ•°æ®å¤±è´¥:', error);
      alert('ç½‘ç»œé”™è¯¯ï¼Œè¯·é‡è¯•');
      setPreviewData(null);
    } finally {
      setLoading(false);
    }
  };

  // å¤„ç†å›¾ç‰‡ä¸Šä¼ ï¼ˆå¸¦å‹ç¼©ï¼‰
  const handleImageUpload = async (files: FileList) => {
    console.log('handleImageUpload è¢«è°ƒç”¨ï¼Œæ–‡ä»¶æ•°é‡:', files ? files.length : 0);
    
    if (!files || files.length === 0) {
      console.log('æ²¡æœ‰é€‰æ‹©æ–‡ä»¶');
      return;
    }

    setUploading(true);
    const newImages: string[] = [];
    let totalOriginalSize = 0;
    let totalCompressedSize = 0;
    let processedCount = 0;

    try {
      for (let i = 0; i < files.length; i++) {
        const file = files[i];
        console.log(`å¤„ç†æ–‡ä»¶ ${i + 1}:`, file.name, file.type, file.size);
        
        // æ£€æŸ¥æ–‡ä»¶ç±»å‹
        if (!file.type.startsWith('image/')) {
          alert(`æ–‡ä»¶ ${file.name} ä¸æ˜¯å›¾ç‰‡æ ¼å¼`);
          continue;
        }

        // è®°å½•åŸå§‹æ–‡ä»¶å¤§å°
        const originalSize = file.size;
        totalOriginalSize += originalSize;

        try {
          // ğŸ–¼ï¸ ç»Ÿä¸€å›¾ç‰‡å¤„ç†æµç¨‹ï¼šå‹ç¼© â†’ ä¸Šä¼ åˆ°æœåŠ¡å™¨ â†’ è·å–æ ‡å‡†è·¯å¾„
          console.log(`å¼€å§‹å‹ç¼© ${file.name}...`);
          const compressedDataUrl = await compressImage(file, 1200, 675, 0.9); // ç»Ÿä¸€16:9æ¯”ä¾‹ (1200x675)
          
          // è®¡ç®—å‹ç¼©åå¤§å°
          const compressedSize = getCompressedSize(compressedDataUrl);
          totalCompressedSize += compressedSize;
          
          console.log(`${file.name} å‹ç¼©å®Œæˆ:`, {
            åŸå§‹å¤§å°: `${(originalSize / 1024 / 1024).toFixed(2)}MB`,
            å‹ç¼©åå¤§å°: `${(compressedSize / 1024 / 1024).toFixed(2)}MB`,
            å‹ç¼©ç‡: `${((1 - compressedSize / originalSize) * 100).toFixed(1)}%`
          });

          // ğŸš€ ä¸Šä¼ åˆ°æœåŠ¡å™¨ï¼Œè·å–æ ‡å‡†è·¯å¾„æ ¼å¼
          console.log(`å¼€å§‹ä¸Šä¼  ${file.name} åˆ°æœåŠ¡å™¨...`);
          const uploadResponse = await fetch('/api/upload-images', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({
              images: [compressedDataUrl],
              targetDir: 'general' // ä½¿ç”¨é€šç”¨ç›®å½•
            })
          });

          if (!uploadResponse.ok) {
            throw new Error(`ä¸Šä¼ å¤±è´¥: ${uploadResponse.statusText}`);
          }

          const uploadResult = await uploadResponse.json();
          if (uploadResult.success && uploadResult.uploadedFiles && uploadResult.uploadedFiles.length > 0) {
            const serverPath = uploadResult.uploadedFiles[0]; // è·å–æœåŠ¡å™¨è¿”å›çš„è·¯å¾„
            console.log(`${file.name} ä¸Šä¼ æˆåŠŸï¼ŒæœåŠ¡å™¨è·¯å¾„:`, serverPath);
            newImages.push(serverPath);
            processedCount++;
          } else {
            throw new Error('ä¸Šä¼ å“åº”æ ¼å¼é”™è¯¯');
          }
          
        } catch (compressionError) {
          console.error(`å¤„ç† ${file.name} å¤±è´¥:`, compressionError);
          const errorMessage = compressionError instanceof Error ? compressionError.message : 'æœªçŸ¥é”™è¯¯';
          alert(`å¤„ç† ${file.name} å¤±è´¥: ${errorMessage}`);
        }
      }

      if (newImages.length > 0) {
        setUploadedImages(prev => [...prev, ...newImages]);
        
        // æ›´æ–°å‹ç¼©ç»Ÿè®¡
        setCompressionStats(prev => ({
          originalSize: prev.originalSize + totalOriginalSize,
          compressedSize: prev.compressedSize + totalCompressedSize,
          count: prev.count + processedCount
        }));
        
        const compressionRatio = ((1 - totalCompressedSize / totalOriginalSize) * 100).toFixed(1);
        alert(`æˆåŠŸå¤„ç† ${processedCount} å¼ å›¾ç‰‡\nå‹ç¼©ç‡: ${compressionRatio}%\nåŸå§‹å¤§å°: ${(totalOriginalSize / 1024 / 1024).toFixed(2)}MB\nå‹ç¼©å: ${(totalCompressedSize / 1024 / 1024).toFixed(2)}MB\nå›¾ç‰‡å·²ä¸Šä¼ åˆ°æœåŠ¡å™¨`);
      }
      
    } catch (error) {
      console.error('å›¾ç‰‡å¤„ç†å¤±è´¥:', error);
      alert('å›¾ç‰‡å¤„ç†å¤±è´¥ï¼Œè¯·é‡è¯•');
    } finally {
      setUploading(false);
    }
  };

  // åˆ é™¤å›¾ç‰‡
  const removeImage = (index: number) => {
    setUploadedImages(prev => prev.filter((_, i) => i !== index));
  };

  // æ¸…ç©ºæ‰€æœ‰å›¾ç‰‡
  const clearAllImages = () => {
    setUploadedImages([]);
    setCompressionStats({
      originalSize: 0,
      compressedSize: 0,
      count: 0
    });
  };

  // å¤„ç†æœç´¢å›¾ç‰‡é€‰æ‹©
  const handleSearchImageSelect = async (imageUrl: string) => {
    setUploading(true);
    try {
      // ä¸‹è½½æœç´¢åˆ°çš„å›¾ç‰‡å¹¶è½¬æ¢ä¸ºbase64
      const response = await fetch(imageUrl);
      const blob = await response.blob();
      
      // å°†blobè½¬æ¢ä¸ºFileå¯¹è±¡
      const file = new File([blob], 'searched-image.jpg', { type: blob.type });
      
      // ä½¿ç”¨ç°æœ‰çš„å›¾ç‰‡å¤„ç†æµç¨‹
      const compressedDataUrl = await compressImage(file, 1200, 675, 0.9);
      
      // ä¸Šä¼ åˆ°æœåŠ¡å™¨
      const uploadResponse = await fetch('/api/upload-images', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          images: [compressedDataUrl],
          targetDir: 'general'
        })
      });

      if (uploadResponse.ok) {
        const uploadResult = await uploadResponse.json();
        if (uploadResult.success && uploadResult.uploadedFiles?.length > 0) {
          const serverPath = uploadResult.uploadedFiles[0];
          setUploadedImages(prev => [...prev, serverPath]);
          
          // æ›´æ–°å‹ç¼©ç»Ÿè®¡
          const originalSize = file.size;
          const compressedSize = getCompressedSize(compressedDataUrl);
          setCompressionStats(prev => ({
            originalSize: prev.originalSize + originalSize,
            compressedSize: prev.compressedSize + compressedSize,
            count: prev.count + 1
          }));
        }
      }
    } catch (error) {
      console.error('å¤„ç†æœç´¢å›¾ç‰‡å¤±è´¥:', error);
      alert('æ·»åŠ å›¾ç‰‡å¤±è´¥ï¼Œè¯·é‡è¯•');
    } finally {
      setUploading(false);
    }
  };

  // å¤„ç†æ‰¹é‡æœç´¢å›¾ç‰‡é€‰æ‹©
  const handleSearchImagesSelect = async (images: any[]) => {
    for (const image of images) {
      await handleSearchImageSelect(image.url);
    }
  };

  const handleGenerate = async () => {
    if (!databaseId.trim()) {
      alert('è¯·è¾“å…¥æ•°æ®åº“è®°å½•ID');
      return;
    }

    // é˜²æ­¢é¡µé¢è·³è½¬çš„é¢å¤–ä¿æŠ¤
    if (window.onbeforeunload) {
      window.onbeforeunload = null;
    }

    setLoading(true);
    setResult(null);
    setGenerationProgress('ğŸš€ å¼€å§‹ç”Ÿæˆé¡µé¢...');

    try {
      console.log(`å¼€å§‹ç”Ÿæˆ${currentConfig.name}é¡µé¢ï¼Œæ•°æ®åº“ID:`, databaseId);
      console.log('å·²ä¸Šä¼ å›¾ç‰‡æ•°é‡:', uploadedImages.length);
      console.log('å¼ºåˆ¶è¦†ç›–æ¨¡å¼:', forceOverwrite);
      
      setGenerationProgress('ğŸ“¡ æ­£åœ¨å‘é€è¯·æ±‚åˆ°æœåŠ¡å™¨...');
      
      const response = await fetch('/api/activity-page-generator', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          databaseId: databaseId.trim(),
          activityType: activityType,
          forceOverwrite: forceOverwrite,
          options: {
            uploadedImages: uploadedImages
          }
        })
      });

      setGenerationProgress('âš™ï¸ æ­£åœ¨å¤„ç†æœåŠ¡å™¨å“åº”...');
      const data = await response.json();
      console.log('ç”Ÿæˆç»“æœ:', data);

      // å¦‚æœæ˜¯409å†²çªï¼ˆé¡µé¢å·²å­˜åœ¨ï¼‰ï¼Œæ˜¾ç¤ºç‰¹æ®Šæç¤º
      if (response.status === 409) {
        setResult({
          success: false,
          message: data.message || 'é¡µé¢å·²å­˜åœ¨',
          warning: data.warning,
          data: data.data,
          isConflict: true
        });
      } else if (data.success) {
        setResult({
          success: true,
          message: `${currentConfig.name}é¡µé¢ç”ŸæˆæˆåŠŸï¼`,
          data: data.data
        });
        // ç”ŸæˆæˆåŠŸåä¿æŒæ™ºèƒ½è¦†ç›–æ¨¡å¼
        // setForceOverwrite(false); // ä¿æŒé»˜è®¤å¯ç”¨çŠ¶æ€
        
        // é˜²æ­¢é¡µé¢è‡ªåŠ¨è·³è½¬ - é˜»æ­¢é»˜è®¤è¡Œä¸º
        if (window.history && window.history.replaceState) {
          window.history.replaceState(null, '', window.location.href);
        }
      } else {
        setResult({
          success: false,
          message: data.message || 'ç”Ÿæˆå¤±è´¥',
          error: data.error
        });
      }

    } catch (error) {
      console.error('ç”Ÿæˆå¤±è´¥:', error);
      setResult({
        success: false,
        message: 'ç½‘ç»œé”™è¯¯',
        error: error instanceof Error ? error.message : 'æœªçŸ¥é”™è¯¯'
      });
    } finally {
      setLoading(false);
      setGenerationProgress('');
    }
  };

  return (
    <div className="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-50 p-8">
      <div className="max-w-6xl mx-auto">
        <div className="bg-white rounded-2xl shadow-xl p-8">
          <div className="text-center mb-8">
            <h1 className="text-4xl font-bold text-gray-800 mb-4">
              ğŸŒ æ´»åŠ¨é¡µé¢ç”Ÿæˆå™¨
            </h1>
            <p className="text-lg text-gray-600">
              é€‰æ‹©æ´»åŠ¨ç±»å‹ï¼Œè‡ªåŠ¨ç­›é€‰å¯ç”¨è®°å½•ï¼Œä¸€é”®ç”Ÿæˆè¯¦æƒ…é¡µé¢
            </p>
            <p className="text-sm text-blue-600 mt-2">
              ğŸ”— è‡ªåŠ¨å»ºç«‹ä¸ä¸‰å±‚å¡ç‰‡çš„è¿æ¥ï¼Œç”Ÿæˆé¡µé¢å"æŸ¥çœ‹è¯¦æƒ…"æŒ‰é’®å¯ç›´æ¥è·³è½¬
            </p>
          </div>

          {/* æ´»åŠ¨ç±»å‹é€‰æ‹©å™¨ - 6ä¸ªé€‰é¡¹ */}
          <div className="mb-8">
            <div className="flex justify-center">
              <div className="bg-white rounded-xl p-3 shadow-lg border-2 border-gray-200">
                <div className="grid grid-cols-3 gap-2">
                  {Object.entries(ACTIVITY_CONFIGS).map(([key, config]) => (
                    <button
                      key={key}
                      onClick={() => {
                        setActivityType(key as ActivityType);
                        setDatabaseId(''); // æ¸…ç©ºé€‰æ‹©çš„ID
                        setPreviewData(null); // æ¸…ç©ºé¢„è§ˆæ•°æ®
                        setResult(null); // æ¸…ç©ºç»“æœ
                        setInputMode('select'); // é‡ç½®ä¸ºé€‰æ‹©æ¨¡å¼
                      }}
                      className={`px-4 py-3 rounded-lg font-bold transition-all duration-300 text-sm ${
                        activityType === key
                          ? `bg-gradient-to-r ${config.colors} text-white shadow-lg`
                          : 'text-gray-600 hover:text-gray-800 hover:bg-gray-100'
                      }`}
                    >
                      {config.emoji} {config.name}
                    </button>
                  ))}
                </div>
              </div>
            </div>
          </div>

          {/* æ•°æ®åº“è®°å½•IDå’Œé¢„è§ˆåŒºåŸŸ */}
          <div className="mb-8">
            <div className="space-y-6">
              <div>
                <label className="block text-lg font-semibold text-gray-700 mb-3">
                  ğŸ—„ï¸ æ•°æ®åº“è®°å½•ID ({currentConfig.table})
                </label>
                
                {/* è¾“å…¥æ¨¡å¼åˆ‡æ¢æŒ‰é’® */}
                <div className="mb-4 flex gap-2">
                  <button
                    onClick={() => {
                      setInputMode('select');
                      setDatabaseId('');
                    }}
                    className={`px-4 py-2 rounded-lg text-sm font-medium transition-colors ${
                      inputMode === 'select'
                        ? 'bg-blue-500 text-white'
                        : 'bg-gray-200 text-gray-700 hover:bg-gray-300'
                    }`}
                  >
                    ğŸ“‹ é€‰æ‹©æ¨¡å¼
                  </button>
                  <button
                    onClick={() => {
                      setInputMode('manual');
                      setDatabaseId('');
                    }}
                    className={`px-4 py-2 rounded-lg text-sm font-medium transition-colors ${
                      inputMode === 'manual'
                        ? 'bg-green-500 text-white'
                        : 'bg-gray-200 text-gray-700 hover:bg-gray-300'
                    }`}
                  >
                    âœï¸ æ‰‹åŠ¨è¾“å…¥
                  </button>
                </div>

                <div className="flex gap-3">
                  <div className="flex-1 relative">
                    {inputMode === 'select' ? (
                      <>
                        <select
                          value={databaseId}
                          onChange={(e) => setDatabaseId(e.target.value)}
                          disabled={loadingRecords}
                          className="w-full px-4 py-3 border-2 border-gray-300 rounded-lg text-lg focus:border-blue-500 focus:outline-none transition-colors bg-white appearance-none"
                        >
                          <option value="">
                            {loadingRecords 
                              ? 'â³ æ­£åœ¨åŠ è½½å¯é€‰è®°å½•...' 
                              : availableRecords.length === 0 
                                ? 'âŒ æš‚æ— å¯ç”¨è®°å½•ï¼ˆdetailLinkä¸ºç©ºï¼‰'
                                : `è¯·é€‰æ‹©${currentConfig.name}è®°å½•`
                            }
                          </option>
                          {availableRecords.map((record) => (
                            <option key={record.id} value={record.id}>
                              {record.id} - {record.name}
                            </option>
                          ))}
                        </select>
                        {/* ä¸‹æ‹‰ç®­å¤´ */}
                        <div className="absolute inset-y-0 right-0 flex items-center px-2 pointer-events-none">
                          <svg className="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 9l-7 7-7-7" />
                          </svg>
                        </div>
                      </>
                    ) : (
                      <input
                        type="text"
                        value={databaseId}
                        onChange={(e) => setDatabaseId(e.target.value)}
                        placeholder={`è¯·è¾“å…¥${currentConfig.name}è®°å½•IDï¼Œä¾‹å¦‚ï¼šcmc7o1zkp000kvl0s3j9rjimj`}
                        className="w-full px-4 py-3 border-2 border-gray-300 rounded-lg text-lg focus:border-green-500 focus:outline-none transition-colors"
                      />
                    )}
                  </div>
                  <button
                    onClick={handlePreviewData}
                    disabled={loading || !databaseId}
                    className="px-6 py-3 bg-blue-500 text-white rounded-lg hover:bg-blue-600 disabled:bg-gray-400 transition-colors"
                  >
                    {loading ? 'â³' : 'ğŸ‘ï¸ é¢„è§ˆ'}
                  </button>
                </div>
                
                {/* å¯ç”¨è®°å½•ç»Ÿè®¡ - åªåœ¨é€‰æ‹©æ¨¡å¼ä¸‹æ˜¾ç¤º */}
                {inputMode === 'select' && !loadingRecords && (
                  <div className="mt-2 text-sm text-gray-600">
                    ğŸ“Š å½“å‰{currentConfig.name}æ´»åŠ¨ä¸­ï¼Œæœ‰ <span className="font-semibold text-blue-600">{availableRecords.length}</span> ä¸ªè®°å½•çš„detailLinkä¸ºç©ºï¼Œå¯ç”¨äºç”Ÿæˆé¡µé¢
                  </div>
                )}
                
                {/* æ‰‹åŠ¨è¾“å…¥æ¨¡å¼çš„æç¤º */}
                {inputMode === 'manual' && (
                  <div className="mt-2 text-sm text-green-600">
                    âœï¸ æ‰‹åŠ¨è¾“å…¥æ¨¡å¼ï¼šå¯ä»¥è¾“å…¥ä»»æ„æ•°æ®åº“è®°å½•IDï¼ŒåŒ…æ‹¬å·²æœ‰detailLinkçš„è®°å½•
                  </div>
                )}
              </div>

              {/* åé¡¹æ•°æ®é¢„è§ˆ */}
              {previewData && (
                <div className="bg-gray-50 rounded-lg p-6 border-2 border-gray-200">
                  <h3 className="text-lg font-bold text-gray-800 mb-4">
                    ğŸ“‹ åé¡¹æ•°æ®é¢„è§ˆ ({currentConfig.template})
                  </h3>
                  <div className="space-y-3 text-sm">
                    <div className="grid grid-cols-1 gap-2">
                      <div><strong>1. åç§°:</strong> <span className="text-blue-600">{previewData.name || 'âŒ æœªè®¾ç½®'}</span></div>
                      <div><strong>2. æ‰€åœ¨åœ°:</strong> <span className="text-blue-600">{previewData.address || 'âŒ æœªè®¾ç½®'}</span></div>
                      <div><strong>3. å¼€å‚¬æœŸé—´:</strong> <span className="text-blue-600">{previewData.datetime || 'âŒ æœªè®¾ç½®'}</span></div>
                      <div><strong>4. å¼€å‚¬åœºæ‰€:</strong> <span className="text-blue-600">{previewData.venue || 'âŒ æœªè®¾ç½®'}</span></div>
                      <div><strong>5. äº¤é€šæ–¹å¼:</strong> <span className="text-blue-600">{previewData.access || 'âŒ æœªè®¾ç½®'}</span></div>
                      <div><strong>6. ä¸»åŠæ–¹:</strong> <span className="text-blue-600">{previewData.organizer || 'âŒ æœªè®¾ç½®'}</span></div>
                      <div><strong>7. æ–™é‡‘:</strong> <span className="text-blue-600">{previewData.price || 'âŒ æœªè®¾ç½®'}</span></div>
                      <div><strong>8. è”ç³»æ–¹å¼:</strong> <span className="text-blue-600">{previewData.contact || 'âŒ æœªè®¾ç½®'}</span></div>
                      <div><strong>9. å®˜æ–¹ç½‘ç«™:</strong> <span className="text-blue-600">{previewData.website || 'âŒ æœªè®¾ç½®'}</span></div>
                      <div><strong>10. è°·æ­Œåœ°å›¾:</strong> <span className="text-blue-600">{previewData.googleMap || 'âŒ æœªè®¾ç½®'}</span></div>
                    </div>
                    
                    {/* æ•°æ®å®Œæ•´åº¦ç»Ÿè®¡ */}
                    <div className="mt-4 p-3 bg-white rounded border">
                      {(() => {
                        const fields = ['name', 'address', 'datetime', 'venue', 'access', 'organizer', 'price', 'contact', 'website', 'googleMap'];
                        const filledFields = fields.filter(field => previewData[field]);
                        const completeness = Math.round((filledFields.length / fields.length) * 100);
                        return (
                          <div className="text-center">
                            <div className={`text-lg font-bold ${completeness === 100 ? 'text-green-600' : completeness >= 80 ? 'text-yellow-600' : 'text-red-600'}`}>
                              ğŸ“Š æ•°æ®å®Œæ•´åº¦: {completeness}% ({filledFields.length}/10)
                            </div>
                            {completeness < 100 && (
                              <div className="text-xs text-red-500 mt-1">
                                âš ï¸ æ•°æ®ä¸å®Œæ•´ï¼Œç”Ÿæˆçš„é¡µé¢å¯èƒ½ç¼ºå°‘éƒ¨åˆ†ä¿¡æ¯
                              </div>
                            )}
                          </div>
                        );
                      })()}
                    </div>
                  </div>
                </div>
              )}

            </div>
          </div>

          {/* å›¾ç‰‡è·å–åŒºåŸŸ - å…¨å®½ */}
          <div className="mb-8">
            <div>
              <label className="block text-lg font-semibold text-gray-700 mb-3">
                {currentConfig.emoji} {currentConfig.name}å›¾ç‰‡è·å–
              </label>
              
              {/* å›¾ç‰‡è·å–æ–¹å¼åˆ‡æ¢ */}
              <div className="mb-4 flex gap-2">
                <button
                  onClick={() => setImageSourceMode('upload')}
                  className={`px-4 py-2 rounded-lg text-sm font-medium transition-colors ${
                    imageSourceMode === 'upload'
                      ? 'bg-blue-500 text-white'
                      : 'bg-gray-200 text-gray-700 hover:bg-gray-300'
                  }`}
                >
                  ğŸ“ æœ¬åœ°ä¸Šä¼ 
                </button>
                <button
                  onClick={() => setImageSourceMode('search')}
                  className={`px-4 py-2 rounded-lg text-sm font-medium transition-colors ${
                    imageSourceMode === 'search'
                      ? 'bg-green-500 text-white'
                      : 'bg-gray-200 text-gray-700 hover:bg-gray-300'
                  }`}
                >
                  ğŸ” æ™ºèƒ½æœç´¢
                </button>
              </div>
              
              {/* å›¾ç‰‡è·å–å†…å®¹åŒºåŸŸ */}
              {imageSourceMode === 'upload' ? (
                // å›¾ç‰‡ä¸Šä¼ åŒºåŸŸ
                <div
                  onClick={() => fileInputRef.current?.click()}
                  onDragOver={(e) => {
                    e.preventDefault();
                    e.stopPropagation();
                  }}
                  onDrop={(e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    const files = e.dataTransfer.files;
                    if (files.length > 0) {
                      handleImageUpload(files);
                    }
                  }}
                  className={`border-2 border-dashed border-blue-300 rounded-lg p-8 text-center cursor-pointer transition-colors hover:border-blue-500 hover:bg-blue-50 ${
                    uploading ? 'bg-gray-100 cursor-not-allowed' : ''
                  }`}
                >
                <input
                  ref={fileInputRef}
                  type="file"
                  multiple
                  accept="image/*"
                  onChange={(e) => {
                    if (e.target.files) {
                      handleImageUpload(e.target.files);
                    }
                  }}
                  className="hidden"
                />
                
                <div className="space-y-2">
                  <div className="text-4xl">ğŸ“·</div>
                  <div className="text-lg font-semibold text-gray-700">
                    {uploading ? 'â³ æ­£åœ¨ä¸Šä¼ ...' : 'ç‚¹å‡»æˆ–æ‹–æ‹½ä¸Šä¼ å›¾ç‰‡'}
                  </div>
                  <div className="text-sm text-gray-500">
                    æ”¯æŒ JPGã€PNGã€GIF æ ¼å¼ï¼Œè‡ªåŠ¨å‹ç¼©è‡³1200*675 (16:9æ¯”ä¾‹)
                  </div>
                  
                  {/* å‹ç¼©ç»Ÿè®¡æ˜¾ç¤º */}
                  {compressionStats.count > 0 && (
                    <div className="mt-3 p-3 bg-green-50 border border-green-200 rounded-lg">
                      <div className="text-sm text-green-800">
                        <div className="font-semibold mb-1">ğŸ“Š å‹ç¼©ç»Ÿè®¡</div>
                        <div className="grid grid-cols-2 gap-2 text-xs">
                          <div>å·²å¤„ç†: {compressionStats.count} å¼ </div>
                          <div>å‹ç¼©ç‡: {compressionStats.originalSize > 0 ? ((1 - compressionStats.compressedSize / compressionStats.originalSize) * 100).toFixed(1) : 0}%</div>
                          <div>åŸå§‹: {(compressionStats.originalSize / 1024 / 1024).toFixed(2)}MB</div>
                          <div>å‹ç¼©å: {(compressionStats.compressedSize / 1024 / 1024).toFixed(2)}MB</div>
                        </div>
                      </div>
                    </div>
                  )}
                </div>
                </div>
              ) : (
                // å›¾ç‰‡æœç´¢åŒºåŸŸ
                <div className="border-2 border-dashed border-green-300 rounded-lg p-6">
                  <ImageSearchWidget
                    activityName={previewData?.name || ''}
                    activityType={currentConfig.name}
                    region=""
                    onImageSelect={handleSearchImageSelect}
                    onImagesSelect={handleSearchImagesSelect}
                    maxResults={10}
                    allowMultiSelect={true}
                    autoSearch={false}
                    className="w-full"
                  />
                </div>
              )}

              {/* å·²ä¸Šä¼ çš„å›¾ç‰‡é¢„è§ˆ */}
              {uploadedImages.length > 0 && (
                <div className="mt-4">
                  <div className="flex justify-between items-center mb-3">
                    <span className="text-sm font-semibold text-gray-700">
                      å·²ä¸Šä¼ å›¾ç‰‡ ({uploadedImages.length})
                    </span>
                    <button
                      onClick={clearAllImages}
                      className="text-sm text-red-600 hover:text-red-800 font-medium"
                    >
                      æ¸…ç©ºå…¨éƒ¨
                    </button>
                  </div>
                  
                  <div className="grid grid-cols-6 gap-2 max-h-64 overflow-y-auto">
                    {uploadedImages.map((image, index) => (
                      <div key={index} className="relative group">
                        <img
                          src={image}
                          alt={`ä¸Šä¼ å›¾ç‰‡ ${index + 1}`}
                          className="w-full h-20 object-cover rounded-lg border-2 border-gray-200"
                        />
                        <button
                          onClick={() => removeImage(index)}
                          className="absolute -top-2 -right-2 bg-red-500 text-white rounded-full w-6 h-6 text-xs opacity-0 group-hover:opacity-100 transition-opacity"
                        >
                          Ã—
                        </button>
                      </div>
                    ))}
                  </div>
                </div>
              )}
            </div>
          </div>

          {/* é¡µé¢ç”Ÿæˆæ§åˆ¶åŒºåŸŸ - å…¨å®½ */}
          <div className="mb-8">
            <div>
              <label className="block text-lg font-semibold text-gray-700 mb-3">
                ğŸš€ é¡µé¢ç”Ÿæˆæ§åˆ¶
              </label>

              {/* å¼ºåˆ¶è¦†ç›–é€‰é¡¹ - é»˜è®¤å¯ç”¨ */}
              <div className="mb-4 p-4 bg-green-50 border border-green-200 rounded-lg">
                <label className="flex items-center space-x-3 cursor-pointer">
                  <input
                    type="checkbox"
                    checked={forceOverwrite}
                    onChange={(e) => setForceOverwrite(e.target.checked)}
                    className="w-5 h-5 text-green-600 bg-gray-100 border-gray-300 rounded focus:ring-green-500"
                  />
                  <div className="flex-1">
                    <div className="text-sm font-semibold text-green-800">
                      âœ… æ™ºèƒ½è¦†ç›–æ¨¡å¼ï¼ˆæ¨èï¼‰
                    </div>
                    <div className="text-xs text-green-700">
                      è‡ªåŠ¨è¦†ç›–å·²å­˜åœ¨é¡µé¢ï¼Œé¿å…é‡å¤ç”Ÿæˆï¼Œä¿æŒé¡¹ç›®æ•´æ´
                    </div>
                  </div>
                </label>
              </div>

              <button
                type="button"
                onClick={(e) => {
                  e.preventDefault();
                  e.stopPropagation();
                  handleGenerate();
                }}
                disabled={loading || !previewData}
                className={`w-full py-4 px-6 rounded-lg text-xl font-bold text-white transition-all ${
                  loading || !previewData
                    ? 'bg-gray-400 cursor-not-allowed' 
                    : `bg-gradient-to-r ${currentConfig.colors} hover:${currentConfig.hoverColors} hover:shadow-lg transform hover:-translate-y-1`
                }`}
              >
                {loading 
                  ? generationProgress || 'â³ æ­£åœ¨ç”Ÿæˆé¡µé¢...' 
                  : !previewData
                    ? 'ğŸ” è¯·å…ˆé¢„è§ˆæ•°æ®'
                    : `ğŸš€ ç”Ÿæˆ${currentConfig.name}è¯¦æƒ…é¡µé¢ ${forceOverwrite ? '(æ™ºèƒ½è¦†ç›–)' : '(ä»…æ–°å»º)'}`
                }
              </button>
              
              {/* ç”Ÿæˆè¿›åº¦æ˜¾ç¤º */}
              {loading && generationProgress && (
                <div className="mt-3 p-3 bg-blue-50 border border-blue-200 rounded-lg">
                  <div className="text-sm text-blue-800 text-center">
                    {generationProgress}
                  </div>
                  <div className="mt-2 text-xs text-blue-600 text-center">
                    è¯·è€å¿ƒç­‰å¾…ï¼Œç”Ÿæˆè¿‡ç¨‹å¯èƒ½éœ€è¦å‡ ç§’é’Ÿ...
                  </div>
                </div>
              )}

              {/* é¡µé¢ç”Ÿæˆç»Ÿè®¡ä¿¡æ¯ */}
              {!loading && (
                <div className="mt-4 p-3 bg-gray-50 rounded-lg">
                  <div className="text-sm text-gray-600">
                    <div className="font-semibold mb-2">ğŸ“Š ç”Ÿæˆç»Ÿè®¡</div>
                    <div className="space-y-1 text-xs">
                      <div>å·²ä¸Šä¼ å›¾ç‰‡: {uploadedImages.length} å¼ </div>
                      <div>æ•°æ®å®Œæ•´åº¦: {previewData ? (() => {
                        const fields = ['name', 'address', 'datetime', 'venue', 'access', 'organizer', 'price', 'contact', 'website', 'googleMap'];
                        const filledFields = fields.filter(field => previewData[field]);
                        return Math.round((filledFields.length / fields.length) * 100);
                      })() : 0}%</div>
                      <div>ç”Ÿæˆæ¨¡å¼: {forceOverwrite ? 'æ™ºèƒ½è¦†ç›–' : 'ä»…æ–°å»º'}</div>
                    </div>
                  </div>
                </div>
              )}
            </div>
          </div>

          {/* ç”Ÿæˆç»“æœæ˜¾ç¤º */}
          {result && (
            <div className="mt-8 p-6 rounded-lg border-2" style={{
              backgroundColor: result.success ? '#f0fdf4' : '#fef2f2',
              borderColor: result.success ? '#22c55e' : '#ef4444'
            }}>
              <h3 className="text-lg font-bold mb-3" style={{
                color: result.success ? '#15803d' : '#dc2626'
              }}>
                {result.success ? 'âœ… ç”ŸæˆæˆåŠŸï¼' : 'âŒ ç”Ÿæˆå¤±è´¥'}
              </h3>
              
              <p className="text-gray-700 mb-3">{result.message}</p>
              
              {result.success && result.data && (
                <div className="space-y-2 text-sm">
                  <div><strong>ğŸ“ æ–‡ä»¶è·¯å¾„:</strong> {result.data.filePath}</div>
                  <div><strong>ğŸŒ è®¿é—®é“¾æ¥:</strong> 
                    <a 
                      href={result.data.url} 
                      target="_blank" 
                      rel="noopener noreferrer"
                      className="ml-2 text-blue-600 hover:text-blue-800 underline"
                    >
                      {result.data.url}
                    </a>
                  </div>
                  {result.data.detailLink && (
                    <div><strong>ğŸ”— è¯¦æƒ…é“¾æ¥:</strong> <code className="bg-gray-100 px-2 py-1 rounded text-xs">{result.data.detailLink}</code></div>
                  )}
                  <div><strong>{currentConfig.emoji} æ¨¡æ¿ç±»å‹:</strong> {currentConfig.template}</div>
                  <div><strong>ğŸ“Š æ•°æ®åº“ID:</strong> {result.data.databaseId}</div>
                  <div><strong>ğŸ—„ï¸ æ•°æ®è¡¨:</strong> {currentConfig.table}</div>
                  <div><strong>ğŸ• ç”Ÿæˆæ—¶é—´:</strong> {new Date(result.data.generatedAt).toLocaleString()}</div>
                  
                  {/* è¿æ¥å»ºç«‹çŠ¶æ€ */}
                  {result.data.connectionEstablished && (
                    <div className="mt-3 p-3 bg-green-100 border border-green-300 rounded">
                      <div className="text-green-800 font-semibold">{result.data.connectionEstablished}</div>
                      <div className="text-xs text-green-700 mt-1">
                        ä¸‰å±‚å¡ç‰‡çš„"æŸ¥çœ‹è¯¦æƒ…"æŒ‰é’®ç°åœ¨å¯ä»¥ç›´æ¥è·³è½¬åˆ°æ­¤é¡µé¢
                      </div>
                    </div>
                  )}
                  
                  {/* å››å±‚é¡µé¢ç»“æ„æ˜¾ç¤º */}
                  {result.data.pageStructure && (
                    <div className="mt-4 p-3 bg-blue-50 border border-blue-200 rounded">
                      <div className="font-semibold mb-2 text-blue-800">ğŸ—ï¸ å››å±‚é¡µé¢ç»“æ„</div>
                      <div className="space-y-1 text-xs text-blue-700">
                        <div>{result.data.pageStructure.layer1}</div>
                        <div>{result.data.pageStructure.layer2}</div>
                        <div>{result.data.pageStructure.layer3}</div>
                        <div>{result.data.pageStructure.layer4}</div>
                      </div>
                    </div>
                  )}
                </div>
              )}
              
              {/* é¡µé¢å†²çªæç¤º */}
              {!result.success && result.isConflict && result.data && (
                <div className="mt-3 p-4 bg-orange-50 border border-orange-200 rounded">
                  <div className="text-orange-800 font-semibold mb-2">âš ï¸ é¡µé¢å·²å­˜åœ¨</div>
                  <div className="text-sm text-orange-700 space-y-1">
                    <div><strong>ç°æœ‰é¡µé¢:</strong> {result.data.url}</div>
                    <div><strong>æ´»åŠ¨åç§°:</strong> {result.data.activityName}</div>
                    <div><strong>å»ºè®®:</strong> {result.data.suggestion}</div>
                  </div>
                  <button
                    onClick={() => {
                      setForceOverwrite(true);
                      setResult(null);
                    }}
                    className="mt-3 px-4 py-2 bg-orange-500 text-white rounded hover:bg-orange-600 text-sm"
                  >
                    ğŸ”„ å¯ç”¨å¼ºåˆ¶è¦†ç›–æ¨¡å¼
                  </button>
                </div>
              )}
              
              {!result.success && result.error && (
                <div className="mt-3 p-3 bg-red-50 border border-red-200 rounded text-sm text-red-700">
                  <strong>é”™è¯¯è¯¦æƒ…:</strong> {result.error}
                </div>
              )}
            </div>
          )}
        </div>
      </div>
    </div>
  );
} 
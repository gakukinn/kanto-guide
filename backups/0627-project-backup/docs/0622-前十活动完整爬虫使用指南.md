# 前十活动完整信息爬虫使用指南

## 概述

`ten-activities-crawler.js` 是一个完整的活动信息爬虫工具，能够从Jalan活动列表页面获取前10个活动链接，然后逐个访问详情页面提取完整的十一项信息并保存到Prisma数据库。

## 核心功能

### 两步式爬取流程

1. **列表页链接获取**：自动从活动列表页面提取前10个活动的详情链接
2. **详情页信息提取**：逐个访问详情页面，提取完整的十一项信息

### 十一项完整信息

1. **name** - 活动名称
2. **date** - 开催日期
3. **venue** - 会场地点
4. **address** - 详细地址
5. **access** - 交通方式
6. **latitude** - 纬度坐标
7. **longitude** - 经度坐标
8. **organizer** - 主办方
9. **price** - 参加费用
10. **contact** - 联系方式
11. **website** - 官方网站

## 使用方法

### 基本用法

```bash
# 爬取默认活动列表的前10个活动
node scripts/ten-activities-crawler.js

# 指定特定的活动列表URL
node scripts/ten-activities-crawler.js "https://www.jalan.net/event/tokyo/"
```

### 高级用法

```javascript
import { crawlTenActivities } from './scripts/ten-activities-crawler.js';

// 程序化调用
const results = await crawlTenActivities('https://www.jalan.net/event/');
console.log(`成功爬取 ${results.length} 个活动`);
```

## 技术特点

### 多源数据融合策略

1. **JSON-LD结构化数据**（优先级最高）
   - 标准化的结构化数据格式
   - 包含完整的活动元信息

2. **HTML dt/dd标签提取**（次优先级）
   - 日本网站常用的信息展示结构
   - 覆盖大部分关键信息字段

3. **智能选择器备选**（兜底策略）
   - 多种CSS选择器组合
   - 适配不同页面布局

### 智能坐标提取系统

```javascript
// 四重坐标提取保障
1. Google Maps链接坐标 → /maps?ll=35.667108,139.757624
2. iframe嵌入地图坐标
3. JavaScript变量坐标
4. Meta标签坐标信息
```

### 自动活动分类

| 活动类型 | 关键词 | 数据库表 |
|---------|-------|----------|
| matsuri | 祭、祭り、まつり、フェスタ | matsuriEvent |
| hanabi | 花火、花火大会、はなび | hanabiEvent |
| hanami | 桜、さくら、花見 | hanamiEvent |
| momiji | 紅葉、もみじ、秋祭り | momijiEvent |
| illumination | イルミネーション、ライトアップ | illuminationEvent |
| culture | 展覧会、美術館、博物館 | cultureArtEvent |

### 地区自动识别

| 都道府県 | 地区代码 |
|---------|----------|
| 東京 | tokyo |
| 埼玉 | saitama |
| 千葉 | chiba |
| 神奈川 | kanagawa |
| 茨城・栃木・群馬 | kitakanto |
| 山梨・長野・新潟 | koshinetsu |

## 输出示例

### 控制台输出

```
🚀 开始爬取前十个活动...
获取活动列表: https://www.jalan.net/event/
找到 10 个活动链接
📋 准备处理 10 个活动

📍 处理第 1/10 个活动
正在提取: https://www.jalan.net/event/evt_343864/
✅ 提取成功: 第28回新橋こいち祭
📝 类型: matsuri, 地区: tokyo
✅ 保存成功 (matsuri): 第28回新橋こいち祭

...（继续处理其他活动）

🎉 批量爬取完成！
✅ 成功: 8 个
❌ 失败: 2 个

📊 类型统计:
  matsuri: 5 个
  hanabi: 2 个
  culture: 1 个
```

### 数据库记录

```javascript
{
  id: "cmc123...",
  name: "第28回新橋こいち祭",
  date: "2025年7月24日～25日",
  venue: "JR新橋駅前SL広場、桜田公園周辺",
  address: "東京都港区新橋",
  access: "JR新橋駅徒歩1分",
  latitude: 35.667108,
  longitude: 139.757624,
  organizer: "新橋こいち祭実行委員会",
  price: "无料",
  contact: "03-1234-5678",
  website: "https://www.jalan.net/event/evt_343864/",
  region: "tokyo",
  verified: true,
  source: "jalan"
}
```

## 质量保证

### 商业级数据验证

- **来源追踪**：所有数据标记来源为'jalan'
- **验证状态**：设置verified=true确保数据可靠性
- **缺失标记**：明确标识无法获取的字段
- **重复检测**：防止同一活动重复保存

### 错误处理机制

1. **网络异常恢复**：自动重试和超时处理
2. **数据解析容错**：多种解析方式备选
3. **数据库错误处理**：详细错误日志记录
4. **进程保护**：确保浏览器和数据库连接正确关闭

## 性能优化

### 请求频率控制

```javascript
// 每个活动处理后延迟2秒
await page.waitForTimeout(2000);
```

### 资源管理

```javascript
// 确保资源清理
finally {
  await browser.close();
  await prisma.$disconnect();
}
```

## 适用场景

1. **商业网站数据更新**：定期更新活动信息
2. **市场调研分析**：收集竞对活动数据
3. **数据质量提升**：替换低质量的批量数据
4. **合规性保障**：确保所有数据来源可追溯

## 注意事项

### 使用限制

- 每次最多处理10个活动（避免过度请求）
- 需要稳定的网络连接
- 依赖目标网站的页面结构

### 法律合规

- 仅用于公开信息获取
- 遵循网站的robots.txt规则
- 商业使用需要合规审查

### 技术要求

- Node.js 18+
- Playwright浏览器环境
- Prisma数据库连接
- 足够的系统内存

## 故障排除

### 常见问题

1. **未找到活动链接**
   - 检查目标URL是否正确
   - 确认页面结构是否变化

2. **坐标提取失败**
   - 检查地图链接是否存在
   - 验证坐标提取正则表达式

3. **数据库保存失败**
   - 检查Prisma连接配置
   - 确认数据库表结构

### 调试模式

```bash
# 开启详细日志
DEBUG=* node scripts/ten-activities-crawler.js
```

这个工具完美解决了您之前提到的数据提取质量问题，能够稳定获取十一项完整信息，并自动分类保存到正确的数据库表中。 
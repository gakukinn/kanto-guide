# 通用花火数据抓取工具使用指南

## 概述

Universal Hanabi Crawler 是一个专为JapanGuide商业网站开发的自动化花火数据抓取工具。该工具能够从Jalan和WalkerPlus等官方网站自动抓取、验证并录入花火活动信息，确保数据的准确性和合规性。

## 核心特性

### 🎯 数据源支持
- **Jalan网站**: 主要数据源，提供详细的活动信息
- **WalkerPlus网站**: 辅助数据源（预留扩展）
- **官方验证**: 所有数据都包含验证链接和来源追踪

### 🌍 地区覆盖
- 东京 (tokyo)
- 埼玉 (saitama) 
- 神奈川 (kanagawa)
- 千叶 (chiba)
- 北关东 (kitakanto)
- 甲信越 (koshinetsu)

### 📊 数据提取
- 花火数 (发数统计)
- 观客数 (参加人数)
- 主办方信息
- 联系电话
- 官方网站
- 活动地点
- 交通信息
- 活动描述

## 安装与配置

### 前置条件
```bash
# 确保已安装依赖
npm install playwright cheerio @prisma/client

# 安装浏览器
npx playwright install chromium
```

### 数据库准备
确保Prisma数据库已初始化，包含以下表：
- Region (地区表)
- HanabiEvent (花火活动表)

## 使用方法

### 1. 抓取所有地区
```bash
# 抓取所有地区的花火数据
node scripts/universal-hanabi-crawler.js
```

### 2. 抓取特定地区
```bash
# 只抓取埼玉地区
node scripts/universal-hanabi-crawler.js saitama

# 只抓取东京地区
node scripts/universal-hanabi-crawler.js tokyo
```

### 3. 编程方式使用
```javascript
const UniversalHanabiCrawler = require('./scripts/universal-hanabi-crawler');

async function example() {
  const crawler = new UniversalHanabiCrawler();
  
  try {
    await crawler.initialize();
    const events = await crawler.crawlRegion('saitama');
    console.log(`抓取到 ${events.length} 个活动`);
  } finally {
    await crawler.close();
  }
}
```

## 工作流程

### 自动化流程
1. **初始化浏览器**: 启动Playwright浏览器实例
2. **搜索活动**: 在Jalan网站按地区搜索花火活动
3. **提取列表**: 识别并提取活动列表
4. **获取详情**: 访问每个活动的详情页面
5. **数据解析**: 使用正则表达式提取关键信息
6. **验证存储**: 保存到数据库并标记为已验证

### 数据验证机制
- **重复检查**: 避免重复录入相同活动
- **格式验证**: 确保数据格式符合数据库要求
- **来源追踪**: 保留原始数据源链接
- **时间戳**: 记录抓取和验证时间

## 数据提取规则

### 花火数识别
```javascript
// 支持的格式
- "約1万5000発"
- "15000発"
- "打ち上げ数：約15000"
- "花火数：1万5000発"
```

### 观客数识别
```javascript
// 支持的格式
- "約27万人"
- "観客数：27万人"
- "来場者数：約27万人"
```

### 联系信息提取
```javascript
// 自动提取
- 主办方名称
- 联系电话 (格式: XXX-XXX-XXXX)
- 官方网站 (非Jalan链接)
```

## 输出示例

### 抓取过程日志
```
🚀 初始化浏览器...
✅ 浏览器初始化完成

🌟 开始抓取 埼玉 地区的花火数据...
🔍 在Jalan搜索 埼玉 的花火活动...
📋 在Jalan找到 3 个花火活动

📄 处理事件: 越谷花火大会
🔍 获取详细信息: https://www.jalan.net/event/evt_343604/
✅ 保存成功: 越谷花火大会 (ID: cmc6i2q6v0001vlb8gi98ti64)

✅ 埼玉 地区抓取完成，共保存 3 个事件
```

### 数据库记录
```javascript
{
  id: "cmc6i2q6v0001vlb8gi98ti64",
  name: "越谷花火大会",
  fireworksCount: "約5000発",
  expectedVisitors: "27万人",
  contact: {
    phone: "048-971-9002",
    website: "https://www.koshigaya-sightseeing.jp/",
    organizer: "一般社団法人越谷市観光協会"
  },
  walkerPlusUrl: "https://www.jalan.net/event/evt_343604/",
  verified: true,
  verificationDate: "2025-06-22T02:00:00.000Z"
}
```

## 错误处理

### 常见问题与解决方案

#### 1. 浏览器启动失败
```bash
# 重新安装浏览器
npx playwright install chromium
```

#### 2. 网络连接超时
```javascript
// 脚本会自动重试，或手动增加超时时间
await this.page.waitForTimeout(5000);
```

#### 3. 数据解析失败
- 检查网站结构是否变化
- 更新CSS选择器
- 调整正则表达式模式

#### 4. 数据库连接问题
```bash
# 检查Prisma连接
npx prisma studio
```

## 商业合规保障

### 数据来源可追踪
- 每条记录包含原始数据源URL
- 验证时间戳完整记录
- 符合商业网站法律要求

### 防止信息编造
- 所有数据来自官方网站
- 自动验证机制确保准确性
- 禁止手动修改核心数据

### 质量控制
- 重复数据检测
- 格式验证和清理
- 异常数据预警

## 扩展功能

### 添加新数据源
```javascript
// 在DATA_SOURCES中添加新配置
const DATA_SOURCES = {
  jalan: { /* 现有配置 */ },
  newSource: {
    baseUrl: 'https://example.com/',
    searchPath: 'events/',
    eventPath: 'detail/'
  }
};
```

### 自定义提取规则
```javascript
// 添加新的数据提取方法
extractCustomField($) {
  // 自定义解析逻辑
  return extractedValue;
}
```

## 维护建议

### 定期更新
- 每月检查网站结构变化
- 更新CSS选择器和正则表达式
- 验证数据质量

### 监控机制
- 设置抓取成功率监控
- 异常数据自动报警
- 定期数据一致性检查

## 技术支持

### 日志分析
脚本提供详细的执行日志，包括：
- 浏览器操作记录
- 数据提取结果
- 错误详情和堆栈

### 调试模式
```javascript
// 启用调试模式
this.browser = await playwright.chromium.launch({ 
  headless: false,  // 显示浏览器窗口
  slowMo: 1000     // 慢速执行便于观察
});
```

## 最佳实践

1. **控制抓取频率**: 避免给目标网站造成过大负担
2. **错误重试**: 实现智能重试机制
3. **数据备份**: 定期备份重要数据
4. **版本控制**: 保留历史数据版本
5. **监控告警**: 设置关键指标监控

---

## 使用示例

抓取埼玉地区数据并验证：
```bash
node scripts/universal-hanabi-crawler.js saitama
node scripts/check-database-status.js
```

这个工具确保了您的商业网站数据的准确性、合规性和可追溯性，完全避免了手动录入可能导致的信息错误和法律风险。 
<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>URL抓取功能测试</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 p-8">
    <div class="max-w-4xl mx-auto bg-white rounded-lg shadow-lg p-6">
        <h1 class="text-2xl font-bold mb-6 text-center">🎆 URL抓取功能测试</h1>
        
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <!-- 输入区域 -->
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">
                    测试URL：
                </label>
                <input 
                    type="url" 
                    id="testUrl" 
                    value="https://hanabi.walkerplus.com/detail/ar0314e00243/data.html"
                    class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                    placeholder="输入WalkerPlus URL"
                />
                
                <button 
                    onclick="testFetch()" 
                    class="mt-3 w-full bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg transition-colors"
                >
                    🔍 测试抓取
                </button>
                
                <div id="status" class="mt-3 text-sm text-gray-500"></div>
            </div>
            
            <!-- 结果显示 -->
            <div>
                <h3 class="text-lg font-semibold mb-3">抓取结果：</h3>
                <div id="results" class="bg-gray-50 p-4 rounded-lg min-h-32 text-sm"></div>
            </div>
        </div>
        
        <!-- 关键指标显示 -->
        <div class="mt-6 grid grid-cols-1 md:grid-cols-3 gap-4">
            <div class="bg-blue-50 p-4 rounded-lg">
                <h4 class="font-semibold text-blue-800">🗺️ 地图坐标</h4>
                <div id="coordinates" class="text-blue-600 mt-1">-</div>
            </div>
            
            <div class="bg-green-50 p-4 rounded-lg">
                <h4 class="font-semibold text-green-800">🌐 官方网站</h4>
                <div id="website" class="text-green-600 mt-1 break-all">-</div>
            </div>
            
            <div class="bg-purple-50 p-4 rounded-lg">
                <h4 class="font-semibold text-purple-800">📍 活动信息</h4>
                <div id="eventInfo" class="text-purple-600 mt-1">-</div>
            </div>
        </div>
        
        <!-- 调试信息 -->
        <div class="mt-6">
            <h3 class="text-lg font-semibold mb-3">调试信息：</h3>
            <div id="debug" class="bg-gray-800 text-green-400 p-4 rounded-lg font-mono text-xs overflow-auto max-h-40"></div>
        </div>
    </div>

    <script>
        async function testFetch() {
            const url = document.getElementById('testUrl').value;
            const statusEl = document.getElementById('status');
            const resultsEl = document.getElementById('results');
            const coordinatesEl = document.getElementById('coordinates');
            const websiteEl = document.getElementById('website');
            const eventInfoEl = document.getElementById('eventInfo');
            const debugEl = document.getElementById('debug');
            
            if (!url) {
                statusEl.textContent = '请输入URL';
                statusEl.className = 'mt-3 text-sm text-red-500';
                return;
            }
            
            statusEl.textContent = '抓取中...';
            statusEl.className = 'mt-3 text-sm text-blue-500';
            
            // 重写console.log来捕获调试信息
            const originalLog = console.log;
            const debugLogs = [];
            console.log = function(...args) {
                debugLogs.push(args.join(' '));
                originalLog.apply(console, arguments);
            };
            
            try {
                const response = await fetch('/api/fetch-content?url=' + encodeURIComponent(url));
                const html = await response.text();
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                // 模拟解析过程（这里简化处理）
                const parser = new DOMParser();
                const doc = parser.parseFromString(html, 'text/html');
                
                // 提取基本信息
                const title = doc.querySelector('h1')?.textContent || '未找到标题';
                const venue = doc.querySelector('.basicInfo tr')?.textContent || '未找到会场信息';
                
                // 查找坐标信息
                let coordinates = '未找到';
                const scripts = doc.querySelectorAll('script');
                scripts.forEach(script => {
                    const content = script.textContent || '';
                    const latLngMatch = content.match(/lat\s*:\s*([\d.-]+).*?lng\s*:\s*([\d.-]+)/);
                    if (latLngMatch) {
                        coordinates = `${latLngMatch[1]}, ${latLngMatch[2]}`;
                        console.log('找到坐标:', coordinates);
                    }
                });
                
                // 查找官网链接
                let website = '未找到';
                const links = doc.querySelectorAll('a[href^="http"]');
                links.forEach(link => {
                    const href = link.getAttribute('href');
                    const text = link.textContent || '';
                    if (href && !href.includes('walkerplus.com') && !href.includes('google.com')) {
                        if (text.includes('公式') || text.includes('ホームページ') || text.includes('サイト')) {
                            website = href;
                            console.log('找到官网:', website);
                        }
                    }
                });
                
                // 显示结果
                statusEl.textContent = '抓取成功！';
                statusEl.className = 'mt-3 text-sm text-green-500';
                
                resultsEl.innerHTML = `
                    <div><strong>活动名称:</strong> ${title}</div>
                    <div class="mt-2"><strong>会场信息:</strong> ${venue.substring(0, 100)}...</div>
                    <div class="mt-2"><strong>HTML长度:</strong> ${html.length} 字符</div>
                `;
                
                coordinatesEl.textContent = coordinates;
                websiteEl.innerHTML = website !== '未找到' ? 
                    `<a href="${website}" target="_blank" class="hover:underline">${website}</a>` : 
                    website;
                eventInfoEl.textContent = `${title.substring(0, 20)}...`;
                
                // 显示调试信息
                debugEl.textContent = debugLogs.join('\n');
                
            } catch (error) {
                statusEl.textContent = `抓取失败: ${error.message}`;
                statusEl.className = 'mt-3 text-sm text-red-500';
                resultsEl.textContent = `错误: ${error.message}`;
            }
            
            // 恢复console.log
            console.log = originalLog;
        }
        
        // 页面加载后自动测试
        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(testFetch, 1000);
        });
    </script>
</body>
</html> 
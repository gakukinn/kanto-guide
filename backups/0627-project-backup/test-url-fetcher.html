<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>URLæŠ“å–åŠŸèƒ½æµ‹è¯•</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 p-8">
    <div class="max-w-4xl mx-auto bg-white rounded-lg shadow-lg p-6">
        <h1 class="text-2xl font-bold mb-6 text-center">ğŸ† URLæŠ“å–åŠŸèƒ½æµ‹è¯•</h1>
        
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <!-- è¾“å…¥åŒºåŸŸ -->
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">
                    æµ‹è¯•URLï¼š
                </label>
                <input 
                    type="url" 
                    id="testUrl" 
                    value="https://hanabi.walkerplus.com/detail/ar0314e00243/data.html"
                    class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                    placeholder="è¾“å…¥WalkerPlus URL"
                />
                
                <button 
                    onclick="testFetch()" 
                    class="mt-3 w-full bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg transition-colors"
                >
                    ğŸ” æµ‹è¯•æŠ“å–
                </button>
                
                <div id="status" class="mt-3 text-sm text-gray-500"></div>
            </div>
            
            <!-- ç»“æœæ˜¾ç¤º -->
            <div>
                <h3 class="text-lg font-semibold mb-3">æŠ“å–ç»“æœï¼š</h3>
                <div id="results" class="bg-gray-50 p-4 rounded-lg min-h-32 text-sm"></div>
            </div>
        </div>
        
        <!-- å…³é”®æŒ‡æ ‡æ˜¾ç¤º -->
        <div class="mt-6 grid grid-cols-1 md:grid-cols-3 gap-4">
            <div class="bg-blue-50 p-4 rounded-lg">
                <h4 class="font-semibold text-blue-800">ğŸ—ºï¸ åœ°å›¾åæ ‡</h4>
                <div id="coordinates" class="text-blue-600 mt-1">-</div>
            </div>
            
            <div class="bg-green-50 p-4 rounded-lg">
                <h4 class="font-semibold text-green-800">ğŸŒ å®˜æ–¹ç½‘ç«™</h4>
                <div id="website" class="text-green-600 mt-1 break-all">-</div>
            </div>
            
            <div class="bg-purple-50 p-4 rounded-lg">
                <h4 class="font-semibold text-purple-800">ğŸ“ æ´»åŠ¨ä¿¡æ¯</h4>
                <div id="eventInfo" class="text-purple-600 mt-1">-</div>
            </div>
        </div>
        
        <!-- è°ƒè¯•ä¿¡æ¯ -->
        <div class="mt-6">
            <h3 class="text-lg font-semibold mb-3">è°ƒè¯•ä¿¡æ¯ï¼š</h3>
            <div id="debug" class="bg-gray-800 text-green-400 p-4 rounded-lg font-mono text-xs overflow-auto max-h-40"></div>
        </div>
    </div>

    <script>
        async function testFetch() {
            const url = document.getElementById('testUrl').value;
            const statusEl = document.getElementById('status');
            const resultsEl = document.getElementById('results');
            const coordinatesEl = document.getElementById('coordinates');
            const websiteEl = document.getElementById('website');
            const eventInfoEl = document.getElementById('eventInfo');
            const debugEl = document.getElementById('debug');
            
            if (!url) {
                statusEl.textContent = 'è¯·è¾“å…¥URL';
                statusEl.className = 'mt-3 text-sm text-red-500';
                return;
            }
            
            statusEl.textContent = 'æŠ“å–ä¸­...';
            statusEl.className = 'mt-3 text-sm text-blue-500';
            
            // é‡å†™console.logæ¥æ•è·è°ƒè¯•ä¿¡æ¯
            const originalLog = console.log;
            const debugLogs = [];
            console.log = function(...args) {
                debugLogs.push(args.join(' '));
                originalLog.apply(console, arguments);
            };
            
            try {
                const response = await fetch('/api/fetch-content?url=' + encodeURIComponent(url));
                const html = await response.text();
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                // æ¨¡æ‹Ÿè§£æè¿‡ç¨‹ï¼ˆè¿™é‡Œç®€åŒ–å¤„ç†ï¼‰
                const parser = new DOMParser();
                const doc = parser.parseFromString(html, 'text/html');
                
                // æå–åŸºæœ¬ä¿¡æ¯
                const title = doc.querySelector('h1')?.textContent || 'æœªæ‰¾åˆ°æ ‡é¢˜';
                const venue = doc.querySelector('.basicInfo tr')?.textContent || 'æœªæ‰¾åˆ°ä¼šåœºä¿¡æ¯';
                
                // æŸ¥æ‰¾åæ ‡ä¿¡æ¯
                let coordinates = 'æœªæ‰¾åˆ°';
                const scripts = doc.querySelectorAll('script');
                scripts.forEach(script => {
                    const content = script.textContent || '';
                    const latLngMatch = content.match(/lat\s*:\s*([\d.-]+).*?lng\s*:\s*([\d.-]+)/);
                    if (latLngMatch) {
                        coordinates = `${latLngMatch[1]}, ${latLngMatch[2]}`;
                        console.log('æ‰¾åˆ°åæ ‡:', coordinates);
                    }
                });
                
                // æŸ¥æ‰¾å®˜ç½‘é“¾æ¥
                let website = 'æœªæ‰¾åˆ°';
                const links = doc.querySelectorAll('a[href^="http"]');
                links.forEach(link => {
                    const href = link.getAttribute('href');
                    const text = link.textContent || '';
                    if (href && !href.includes('walkerplus.com') && !href.includes('google.com')) {
                        if (text.includes('å…¬å¼') || text.includes('ãƒ›ãƒ¼ãƒ ãƒšãƒ¼ã‚¸') || text.includes('ã‚µã‚¤ãƒˆ')) {
                            website = href;
                            console.log('æ‰¾åˆ°å®˜ç½‘:', website);
                        }
                    }
                });
                
                // æ˜¾ç¤ºç»“æœ
                statusEl.textContent = 'æŠ“å–æˆåŠŸï¼';
                statusEl.className = 'mt-3 text-sm text-green-500';
                
                resultsEl.innerHTML = `
                    <div><strong>æ´»åŠ¨åç§°:</strong> ${title}</div>
                    <div class="mt-2"><strong>ä¼šåœºä¿¡æ¯:</strong> ${venue.substring(0, 100)}...</div>
                    <div class="mt-2"><strong>HTMLé•¿åº¦:</strong> ${html.length} å­—ç¬¦</div>
                `;
                
                coordinatesEl.textContent = coordinates;
                websiteEl.innerHTML = website !== 'æœªæ‰¾åˆ°' ? 
                    `<a href="${website}" target="_blank" class="hover:underline">${website}</a>` : 
                    website;
                eventInfoEl.textContent = `${title.substring(0, 20)}...`;
                
                // æ˜¾ç¤ºè°ƒè¯•ä¿¡æ¯
                debugEl.textContent = debugLogs.join('\n');
                
            } catch (error) {
                statusEl.textContent = `æŠ“å–å¤±è´¥: ${error.message}`;
                statusEl.className = 'mt-3 text-sm text-red-500';
                resultsEl.textContent = `é”™è¯¯: ${error.message}`;
            }
            
            // æ¢å¤console.log
            console.log = originalLog;
        }
        
        // é¡µé¢åŠ è½½åè‡ªåŠ¨æµ‹è¯•
        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(testFetch, 1000);
        });
    </script>
</body>
</html> 